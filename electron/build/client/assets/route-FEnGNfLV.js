var xo=Object.defineProperty;var Ao=(r,e,t)=>e in r?xo(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Je=(r,e,t)=>(Ao(r,typeof e!="symbol"?e+"":e,t),t);import{r as H,j as F,g as Ra}from"./jsx-runtime-ddOyjiFJ.js";import{r as Eo,f as Vr,o as Oo,q as Po,s as ei,t as ko,v as To,w as So}from"./components-EjjKQUqg.js";import{c as ti,$ as Co,_ as Io,a as Ro,l as rr,B as No,g as jo}from"./server-F_ve6JoJ.js";/**
 * @remix-run/server-runtime v2.6.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */const $o=(r,e=302)=>Eo(r,e);function ms(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable})),t.push.apply(t,n)}return t}function ue(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ms(Object(t),!0).forEach(function(n){Lo(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ms(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function Lo(r,e,t){return e=Do(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Mo(r,e){if(typeof r!="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function Do(r){var e=Mo(r,"string");return typeof e=="symbol"?e:String(e)}function Fo(r,e){var t=new FormData(r,e);if(e&&e.type==="submit"&&e.name!==""){var n=t.getAll(e.name);n.includes(e.value)||t.append(e.name,e.value)}return t}function Ze(r){return r?r.split(/\.|(\[\d*\])/).reduce((e,t)=>{if(typeof t<"u"&&t!=="")if(t.startsWith("[")&&t.endsWith("]")){var n=t.slice(1,-1);e.push(Number(n))}else e.push(t);return e},[]):[]}function bt(r){return r.reduce((e,t)=>typeof t=="number"?"".concat(e,"[").concat(Number.isNaN(t)?"":t,"]"):e===""||t===""?[e,t].join(""):[e,t].join("."),"")}function Rn(r,e){var t=Ze(r),n=Ze(e);return t.length>=n.length&&n.every((a,s)=>t[s]===a)}function rt(r,e,t){for(var n=Ze(e),a=n.length,s=a-1,i=-1,o=r;o!=null&&++i<a;){var u,c=n[i],l=n[i+1],d=i!=s?(u=o[c])!==null&&u!==void 0?u:typeof l=="number"?[]:{}:t(o[c]);o[c]=d,o=o[c]}}function Nn(r,e){var t=r;for(var n of Ze(e)){if(typeof t>"u"||t==null)break;if(nt(t)&&typeof n=="string")t=t[n];else if(Array.isArray(t)&&typeof n=="number")t=t[n];else return}return t}function nt(r){return!!r&&r.constructor===Object&&Object.getPrototypeOf(r)===Object.prototype}function Uo(r){return typeof File>"u"?!1:r instanceof File}function pt(r){if(nt(r)){var e=Object.keys(r).sort().reduce((t,n)=>{var a=pt(r[n]);return typeof a<"u"&&(t[n]=a),t},{});return Object.keys(e).length===0?void 0:e}if(Array.isArray(r))return r.length===0?void 0:r.map(pt);if(!(typeof r=="string"&&r===""||r===null||Uo(r)))return r}function Na(r,e){var t,n={},a=(t=e==null?void 0:e.resolve)!==null&&t!==void 0?t:l=>l;function s(l,d){var h=pt(a(l));typeof h<"u"&&(n[d]=h)}function i(l,d){s(l,d);for(var[h,m]of Object.entries(l)){var f=d?"".concat(d,".").concat(h):h;Array.isArray(m)?o(m,f):m&&nt(m)?i(m,f):s(m,f)}}function o(l,d){s(l,d);for(var h=0;h<l.length;h++){var m=l[h],f="".concat(d,"[").concat(h,"]");Array.isArray(m)?o(m,f):m&&nt(m)?i(m,f):s(m,f)}}if(r){var u,c=(u=e==null?void 0:e.prefix)!==null&&u!==void 0?u:"";Array.isArray(r)?o(r,c):i(r,c)}return n}function Rt(r,e){if(!r)throw new Error(e)}function jn(){return(Date.now()*Math.random()).toString(36)}function nr(r){return JSON.parse(JSON.stringify(r))}function Bo(r){return r instanceof Element&&(r.tagName==="INPUT"||r.tagName==="SELECT"||r.tagName==="TEXTAREA"||r.tagName==="BUTTON")}function Vn(r){return Bo(r)&&r.type!=="submit"&&r.type!=="button"&&r.type!=="reset"}function Zo(r){var e,t,n=r.target,a=r.submitter;return(e=(t=a==null?void 0:a.getAttribute("formaction"))!==null&&t!==void 0?t:n.getAttribute("action"))!==null&&e!==void 0?e:"".concat(location.pathname).concat(location.search)}function Vo(r){var e,t=r.target,n=r.submitter,a=(e=n==null?void 0:n.getAttribute("formenctype"))!==null&&e!==void 0?e:t.enctype;return a==="multipart/form-data"?a:"application/x-www-form-urlencoded"}function zo(r){var e,t,n=r.target,a=r.submitter,s=(e=(t=a==null?void 0:a.getAttribute("formmethod"))!==null&&t!==void 0?t:n.getAttribute("method"))===null||e===void 0?void 0:e.toUpperCase();switch(s){case"POST":case"PUT":case"PATCH":case"DELETE":return s}return"GET"}function Ho(r,e){if(Rt(!!r,"Failed to submit the form. The element provided is null or undefined."),typeof r.requestSubmit=="function")r.requestSubmit(e);else{var t=new SubmitEvent("submit",{bubbles:!0,cancelable:!0,submitter:e});r.dispatchEvent(t)}}var $r="__intent__",Nt="__state__";function ri(r){var e=r.get($r),t=r.get(Nt),n={},a=[];Rt((typeof e=="string"||e===null)&&(typeof t=="string"||t===null),'The input name "'.concat($r,'" and "').concat(Nt,'" are reserved by Conform. Please use another name for your input.'));var s=function(c){if(i===$r||i===Nt)return 1;a.push(i),rt(n,i,l=>l?Array.isArray(l)?l.concat(c):[l,c]:c)};for(var[i,o]of r.entries())s(o);return{payload:n,intent:Ko(e),state:t?JSON.parse(t):{validated:{}},fields:a}}function qo(r,e){var t=ri(r),n=t.intent;if(n)switch(n.type){case"validate":n.payload.name&&(t.state.validated[n.payload.name]=!0);break;case"update":{var{name:a,value:s,validated:i}=n.payload;typeof s<"u"&&(a?rt(t.payload,a,()=>s):t.payload=s),typeof i<"u"&&(a?zr(t.state.validated,a,()=>{}):t.state.validated={},i?((nt(s)||Array.isArray(s))&&Object.assign(t.state.validated,Na(s,{resolve(){return!0},prefix:a})),t.state.validated[a??""]=!0):a&&delete t.state.validated[a]);break}case"reset":{var{name:o}=n.payload;o?(rt(t.payload,o,()=>{}),zr(t.state.validated,o,()=>{}),delete t.state.validated[o]):(t.payload={},t.state.validated={});break}case"insert":case"remove":case"reorder":{ni(t.payload,n),ai(t.state.validated,n),t.state.validated[n.payload.name]=!0;break}}var u=e.resolve(t.payload,n),c=l=>{var d=typeof l.error<"u"?l.error:{};if(!n||n.type==="validate"&&!n.payload.name)for(var h of[...t.fields,...Object.keys(d??{})])t.state.validated[h]=!0;return Wo(ue(ue({},t),{},{value:l.value,error:l.error}))};return u instanceof Promise?u.then(c):c(u)}function Wo(r){return r.intent||!r.value||r.error?{status:r.intent?void 0:"error",payload:r.payload,error:typeof r.error<"u"?r.error:{},reply(e){return ps(r,e)}}:{status:"success",payload:r.payload,value:r.value,reply(e){return ps(r,e)}}}function ps(r){var e,t,n,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch((e=r.intent)===null||e===void 0?void 0:e.type){case"reset":{var s,i=(s=r.intent.payload.name)!==null&&s!==void 0?s:"";if(i==="")return{initialValue:null}}}if("resetForm"in a&&a.resetForm)return{initialValue:null};if("hideFields"in a&&a.hideFields)for(var o of a.hideFields){var u=Nn(r.payload,o);typeof u<"u"&&rt(r.payload,o,()=>{})}var c=Object.entries((t=r.error)!==null&&t!==void 0?t:{}).reduce((h,m)=>{var[f,v]=m;return r.state.validated[f]&&(h[f]=v),h},{}),l="formErrors"in a||"fieldErrors"in a?pt(ue({"":a.formErrors},a.fieldErrors)):null,d=pt(ue(ue({},c),l));return{status:r.intent?void 0:d?"error":"success",intent:r.intent?r.intent:void 0,initialValue:(n=pt(r.payload))!==null&&n!==void 0?n:{},error:d,state:r.state}}function Ko(r){if(!r)return null;var e=JSON.parse(r);if(typeof e.type!="string"||typeof e.payload>"u")throw new Error("Unknown form control intent");return e}function Jo(r){return JSON.stringify(r)}function ua(r,e){var t;switch(Rt(Array.isArray(r),"Failed to update list. The value is not an array."),e.type){case"insert":r.splice((t=e.payload.index)!==null&&t!==void 0?t:r.length,0,Hr(e.payload.defaultValue));break;case"remove":r.splice(e.payload.index,1);break;case"reorder":r.splice(e.payload.to,0,...r.splice(e.payload.from,1));break;default:throw new Error("Unknown list intent received")}}function ni(r,e){rt(r,e.payload.name,t=>{var n=t??[];return ua(n,e),n})}function zr(r,e,t){var n=Symbol.for("root"),a=Object.keys(r).sort((c,l)=>l.localeCompare(c)),s={},i=function(){var l=r[o];Rn(o,e)&&o!==e&&(rt(s,o,d=>typeof d>"u"?l:(d[n]=l,d)),delete r[o])};for(var o of a)i();var u=t(Nn(s,e));Object.assign(r,Na(u,{resolve(c){if(nt(c)||Array.isArray(c)){var l;return(l=c[n])!==null&&l!==void 0?l:null}return c},prefix:e}))}function ai(r,e,t){zr(r,e.payload.name,n=>{var a=n??[];switch(e.type){case"insert":ua(a,{type:e.type,payload:ue(ue({},e.payload),{},{defaultValue:t==null?void 0:t()})});break;default:ua(a,e);break}return a})}function Hr(r){return nt(r)?Object.entries(r).reduce((e,t)=>{var[n,a]=t;return e[n]=Hr(a),e},{}):Array.isArray(r)?r.map(Hr):r instanceof Date?r.toISOString():typeof r=="boolean"?r?"on":void 0:typeof r=="number"?r.toString():r??void 0}function gs(r,e){var t,n,a,s,i,o=e?void 0:r.lastResult,u=r.defaultValue?Hr(r.defaultValue):{},c=(t=o==null?void 0:o.initialValue)!==null&&t!==void 0?t:u,l={submissionStatus:o==null?void 0:o.status,defaultValue:u,initialValue:c,value:c,constraint:(n=r.constraint)!==null&&n!==void 0?n:{},validated:(a=o==null||(s=o.state)===null||s===void 0?void 0:s.validated)!==null&&a!==void 0?a:{},key:e?ue({"":jn()},ca(u)):ca(u),error:(i=o==null?void 0:o.error)!==null&&i!==void 0?i:{}};return o!=null&&o.intent&&si(l,o.intent),l}function ca(r,e){return Object.entries(Na(r,{prefix:e})).reduce((t,n)=>{var[a,s]=n;if(Array.isArray(s))for(var i=0;i<s.length;i++)t[bt([...Ze(a),i])]=jn();return t},{})}function si(r,e,t){switch(e.type){case"update":{if(typeof e.payload.value<"u"){var n,a=(n=e.payload.name)!==null&&n!==void 0?n:"",s=e.payload.value;ys(r,a,s)}break}case"reset":{var i,o=(i=e.payload.name)!==null&&i!==void 0?i:"",u=Nn(r.defaultValue,o);ys(r,o,u);break}case"insert":case"remove":case"reorder":{t&&(r.initialValue=nr(r.initialValue),r.key=nr(r.key),ai(r.key,e,jn),ni(r.initialValue,e));break}}}function ys(r,e,t){r.initialValue=nr(r.initialValue),r.value=nr(r.value),r.key=nr(r.key),rt(r.initialValue,e,()=>t),rt(r.value,e,()=>t),(nt(t)||Array.isArray(t))&&(zr(r.key,e,()=>{}),Object.assign(r.key,ca(t,e))),r.key[e]=jn()}function wr(r){var e={};return new Proxy(e,{get(t,n,a){var s;return(s=e[n])!==null&&s!==void 0?s:e[n]=r(n,a)}})}function zn(r){var e=pt(r);return wr((t,n)=>{if(t==="")return e;var a=Ze(t),s=bt(a.slice(0,-1)),i=bt(a.slice(-1)),o=n[s];return Nn(o,i)})}function Go(r){return wr((e,t)=>{var n,a=r[e];if(!a){for(var s=Ze(e),i=s.length-1;i>=0;i--){var o=s[i];if(typeof o=="number"&&!Number.isNaN(o)){s[i]=Number.NaN;break}}var u=bt(s);e!==u&&(a=t[u])}return(n=a)!==null&&n!==void 0?n:{}})}function Xo(r){return wr((e,t)=>{var n=r[e],a=Ze(e);if(a.length===0)return n;var s=t[bt(a.slice(0,-1))];return typeof s>"u"?n:"".concat(s,"/").concat(n??a.at(-1))})}function Qo(r){return wr(e=>{var t=Object.keys(r);if(e==="")return t.length===0;for(var n of t)if(Rn(n,e)&&typeof r[n]<"u")return!1;return!0})}function Yo(r,e,t){return wr(n=>JSON.stringify(r[n])!==JSON.stringify(e[n],(a,s)=>n===""&&a===""&&s?Object.entries(s).reduce((i,o)=>{var[u,c]=o;return t(u)?Object.assign(i??{},{[u]:c}):i},void 0):s))}function Et(r,e,t,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:(m,f)=>JSON.stringify(m)!==JSON.stringify(f);if(n&&r!==e){var s,i,o=(s=n.prefix)!==null&&s!==void 0?s:[],u=(i=n.name)!==null&&i!==void 0?i:[],c=o.length===0?u:Array.from(new Set([...Object.keys(r),...Object.keys(e)])),l=function(f){if(o.length===0||u.includes(f)||o.some(p=>Rn(f,p))){var v;if((v=t[f])!==null&&v!==void 0||(t[f]=a(r[f],e[f])),t[f])return{v:!0}}},d;for(var h of c)if(d=l(h),d)return d.v}return!1}function eu(r){var e=[],t=r,n=gs(r),a=i(n);function s(){var b=document.forms.namedItem(t.formId);return Rt(b!==null,"Form#".concat(t.formId," does not exist")),b}function i(b){var _=arguments.length>1&&arguments[1]!==void 0?arguments[1]:b,x=arguments.length>2?arguments[2]:void 0,L=!x||_.defaultValue!==b.defaultValue?zn(b.defaultValue):x.defaultValue,X=b.initialValue===b.defaultValue?L:!x||_.initialValue!==b.initialValue?zn(b.initialValue):x.initialValue,_e=b.value===b.initialValue?X:!x||_.value!==b.value?zn(b.value):x.value;return{submissionStatus:b.submissionStatus,defaultValue:L,initialValue:X,value:_e,error:!x||_.error!==b.error?b.error:x.error,validated:b.validated,constraint:!x||_.constraint!==b.constraint?Go(b.constraint):x.constraint,key:!x||_.key!==b.key?Xo(b.key):x.key,valid:!x||_.error!==b.error?Qo(b.error):x.valid,dirty:!x||_.defaultValue!==b.defaultValue||_.value!==b.value?Yo(L,_e,pe=>{var te,Ke;return(te=(Ke=t.shouldDirtyConsider)===null||Ke===void 0?void 0:Ke.call(t,pe))!==null&&te!==void 0?te:!0}):x.dirty}}function o(b){var _=n,x=a,L=i(b,_,x);n=b,a=L;var X={value:{},error:{},initialValue:{},key:{},valid:{},dirty:{}};for(var _e of e){var pe,te=(pe=_e.getSubject)===null||pe===void 0?void 0:pe.call(_e);(!te||te.status&&x.submissionStatus!==L.submissionStatus||Et(x.error,L.error,X.error,te.error)||Et(x.initialValue,L.initialValue,X.initialValue,te.initialValue)||Et(x.key,L.key,X.key,te.key,(Ke,Zn)=>Ke!==Zn)||Et(x.valid,L.valid,X.valid,te.valid,u)||Et(x.dirty,L.dirty,X.dirty,te.dirty,u)||Et(x.value,L.value,X.value,te.value))&&_e.callback()}}function u(){var b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,_=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return b!==_}function c(b){var _=b.elements.namedItem(Nt);if(Rt(_===null||Vn(_),'The input name "'.concat(Nt,'" is reserved by Conform. Please use another name.')),!_){var x=document.createElement("input");return x.type="hidden",x.name=Nt,x.value="",b.append(x),x}return _}function l(){return JSON.stringify({validated:n.validated})}function d(b){var _=b.target,x=b.submitter;Rt(_===s(),"The submit event is dispatched by form#".concat(_.id," instead of form#").concat(t.formId));var L=c(_);L.value=l();var X=Fo(_,x),_e={formData:X,action:Zo(b),encType:Vo(b),method:zo(b)};if(typeof(t==null?void 0:t.onValidate)>"u")return _e;var pe=t.onValidate({form:_,formData:X,submitter:x});return pe.status!=="success"&&pe.error!==null&&E(pe.reply()),ue(ue({},_e),{},{submission:pe})}function h(b){var _=s(),x=b.target;return!Vn(x)||x.form!==_||x.name===""?null:x}function m(b,_){var{shouldValidate:x="onSubmit",shouldRevalidate:L=x}=t,X=n.validated[b.name];return X?L===_:x===_}function f(b){var _=h(b);if(!(!_||!_.form))if(b.defaultPrevented||!m(_,"onInput")){var x=new FormData(_.form),L=ri(x);o(ue(ue({},n),{},{value:L.payload}))}else Z({type:"validate",payload:{name:_.name}})}function v(b){var _=h(b);!_||b.defaultPrevented||!m(_,"onBlur")||Z({type:"validate",payload:{name:_.name}})}function p(b){var _=s();b.type!=="reset"||b.target!==_||b.defaultPrevented||o(gs(t,!0))}function E(b){var _,x,L,X=s();if(!b.initialValue){X.reset();return}var _e=Object.entries((_=b.error)!==null&&_!==void 0?_:{}).reduce((Ke,Zn)=>{var[ds,hs]=Zn,fs=hs===null?n.error[ds]:hs;return fs&&(Ke[ds]=fs),Ke},{}),pe=ue(ue({},n),{},{submissionStatus:b.status,value:b.initialValue,error:_e,validated:(x=(L=b.state)===null||L===void 0?void 0:L.validated)!==null&&x!==void 0?x:{}});if(b.intent&&si(pe,b.intent,!0),o(pe),b.status==="error"){for(var te of X.elements)if(Vn(te)&&_e[te.name]){te.focus();break}}}function k(b){var _=t.formId,x=t.lastResult;Object.assign(t,b),t.formId!==_?s().reset():b.lastResult&&b.lastResult!==x&&E(b.lastResult)}function I(b,_){var x={callback:b,getSubject:_};return e.push(x),()=>{e=e.filter(L=>L!==x)}}function B(){return a}function Z(b){var _=s(),x=document.createElement("button"),L=K(b);x.name=L.name,x.value=L.value,x.hidden=!0,x.formNoValidate=!0,_==null||_.appendChild(x),Ho(_,x),_==null||_.removeChild(x)}function K(b){return{name:$r,value:Jo(b),form:t.formId,formNoValidate:!0}}function z(b){var _=function(){var L=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Z({type:b,payload:L})};return Object.assign(_,{getButtonProps(){var x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return K({type:b,payload:x})}})}return{get formId(){return t.formId},submit:d,onReset:p,onInput:f,onBlur:v,onUpdate:k,validate:z("validate"),reset:z("reset"),update:z("update"),insert:z("insert"),remove:z("remove"),reorder:z("reorder"),subscribe:I,getState:B,getSerializedState:l}}function bs(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable})),t.push.apply(t,n)}return t}function ge(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?bs(Object(t),!0).forEach(function(n){tu(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):bs(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function tu(r,e,t){return e=au(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function ru(r,e){if(r==null)return{};var t={},n=Object.keys(r),a,s;for(s=0;s<n.length;s++)a=n[s],!(e.indexOf(a)>=0)&&(t[a]=r[a]);return t}function ii(r,e){if(r==null)return{};var t=ru(r,e),n,a;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);for(a=0;a<s.length;a++)n=s[a],!(e.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(r,n)&&(t[n]=r[n])}return t}function nu(r,e){if(typeof r!="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function au(r){var e=nu(r,"string");return typeof e=="symbol"?e:String(e)}var su=["onSubmit"],iu=Symbol("wrapped");function ou(r,e){var t=H.useCallback(n=>r.subscribe(n,()=>e==null?void 0:e.current),[r,e]);return H.useSyncExternalStore(t,r.getState,r.getState)}function uu(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=H.useRef(r);return e.current=r,e}function la(r,e,t,n){if(t==="status")r.current[t]=!0;else{var a,s;r.current[t]=ge(ge({},r.current[t]),{},{[n]:((a=(s=r.current[t])===null||s===void 0?void 0:s[n])!==null&&a!==void 0?a:[]).concat(e)})}}function oi(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=n?"".concat(r,"-").concat(n):r;return new Proxy({id:a,name:n,errorId:"".concat(a,"-error"),descriptionId:"".concat(a,"-description"),get initialValue(){return e.initialValue[n]},get value(){return e.value[n]},get errors(){return e.error[n]},get key(){return e.key[n]},get valid(){return e.valid[n]},get dirty(){return e.dirty[n]},get allErrors(){if(n==="")return e.error;var s={};for(var[i,o]of Object.entries(e.error))Rn(i,n)&&(s[i]=o);return s},get getFieldset(){return()=>new Proxy({},{get(s,i,o){return typeof i=="string"?ui(r,e,t,n,i):Reflect.get(s,i,o)}})}},{get(s,i,o){switch(i){case"key":case"initialValue":case"value":case"valid":case"dirty":la(t,n,i,"name");break;case"errors":case"allErrors":la(t,n,"error",i==="errors"?"name":"prefix");break}return Reflect.get(s,i,o)}})}function ui(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=arguments.length>4?arguments[4]:void 0,s=typeof a>"u"?n:bt([...Ze(n),a]),i=oi(r,e,t,s);return new Proxy({},{get(o,u,c){var l;switch(u){case"formId":return r;case"required":case"minLength":case"maxLength":case"min":case"max":case"pattern":case"step":case"multiple":return(l=e.constraint[s])===null||l===void 0?void 0:l[u];case"getFieldList":return()=>{var d,h=(d=e.initialValue[s])!==null&&d!==void 0?d:[];if(la(t,s,"initialValue","name"),!Array.isArray(h))throw new Error("The initial value at the given name is not a list");return Array(h.length).fill(0).map((m,f)=>ui(r,e,t,s,f))}}return Reflect.get(i,u,c)}})}function cu(r,e,t,n,a){var s=oi(r,e,t);return new Proxy({},{get(i,o,u){switch(o){case"context":return{[iu]:n};case"status":return e.submissionStatus;case"validate":case"update":case"reset":case"insert":case"remove":case"reorder":return n[o];case"onSubmit":return n.submit;case"noValidate":return a}return Reflect.get(s,o,u)}})}function lu(r){var{onSubmit:e}=r,t=ii(r,su),n=eu(t);return ge(ge({},n),{},{submit(a){var s=a.nativeEvent,i=n.submit(s);if(i.submission&&i.submission.status!=="success"&&i.submission.error!==null)a.preventDefault();else{var o;(o=e)===null||o===void 0||o(a,i)}},onUpdate(a){e=a.onSubmit,n.onUpdate(a)}})}var du=["id"],da=typeof document>"u"?H.useEffect:H.useLayoutEffect;function hu(r){var e=H.useId();return r??e}function fu(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,[e,t]=H.useState(r);return da(()=>{e||t(!0)},[e]),e}function mu(r){var{id:e}=r,t=ii(r,du),n=hu(e),[a]=H.useState(()=>lu(ge(ge({},t),{},{formId:n})));da(()=>(document.addEventListener("input",a.onInput),document.addEventListener("focusout",a.onBlur),document.addEventListener("reset",a.onReset),()=>{document.removeEventListener("input",a.onInput),document.removeEventListener("focusout",a.onBlur),document.removeEventListener("reset",a.onReset)}),[a]),da(()=>{a.onUpdate(ge(ge({},t),{},{formId:n}))});var s=uu(),i=ou(a,s),o=fu(r.defaultNoValidate),u=cu(n,i,s,a,o);return[u,u.getFieldset()]}function xr(r){for(var e in r)r[e]===void 0&&delete r[e];return r}function ci(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e.ariaAttributes<"u"&&!e.ariaAttributes)return{};var t=e.ariaInvalid==="allErrors"?!r.valid:typeof r.errors<"u",n=e.ariaDescribedBy;return xr({"aria-invalid":t||void 0,"aria-describedby":t?"".concat(r.errorId," ").concat(n??"").trim():n})}function pu(r,e){return xr(ge({id:r.id,onSubmit:r.onSubmit,noValidate:r.noValidate},ci(r,e)))}function gu(r,e){return xr(ge({id:r.id,name:r.name,form:r.formId},ci(r,e)))}function yu(r,e){return xr(ge({key:r.key,required:r.required||void 0},gu(r,e)))}function bu(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=ge(ge({},yu(r,e)),{},{minLength:r.minLength,maxLength:r.maxLength});return(typeof e.value>"u"||e.value)&&(t.defaultValue=r.initialValue),xr(t)}function _s(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable})),t.push.apply(t,n)}return t}function D(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?_s(Object(t),!0).forEach(function(n){_u(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):_s(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function _u(r,e,t){return e=wu(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function vu(r,e){if(typeof r!="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function wu(r){var e=vu(r,"string");return typeof e=="symbol"?e:String(e)}var N;(function(r){r.assertEqual=a=>a;function e(a){}r.assertIs=e;function t(a){throw new Error}r.assertNever=t,r.arrayToEnum=a=>{const s={};for(const i of a)s[i]=i;return s},r.getValidEnumValues=a=>{const s=r.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(const o of s)i[o]=a[o];return r.objectValues(i)},r.objectValues=a=>r.objectKeys(a).map(function(s){return a[s]}),r.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const s=[];for(const i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},r.find=(a,s)=>{for(const i of a)if(s(i))return i},r.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function n(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}r.joinValues=n,r.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(N||(N={}));var ha;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(ha||(ha={}));const w=N.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),et=r=>{switch(typeof r){case"undefined":return w.undefined;case"string":return w.string;case"number":return isNaN(r)?w.nan:w.number;case"boolean":return w.boolean;case"function":return w.function;case"bigint":return w.bigint;case"symbol":return w.symbol;case"object":return Array.isArray(r)?w.array:r===null?w.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?w.promise:typeof Map<"u"&&r instanceof Map?w.map:typeof Set<"u"&&r instanceof Set?w.set:typeof Date<"u"&&r instanceof Date?w.date:w.object;default:return w.unknown}},y=N.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),xu=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:");class Te extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(s){return s.message},n={_errors:[]},a=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)n._errors.push(t(i));else{let o=n,u=0;for(;u<i.path.length;){const c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),n}toString(){return this.message}get message(){return JSON.stringify(this.issues,N.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):n.push(e(a));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Te.create=r=>new Te(r);const or=(r,e)=>{let t;switch(r.code){case y.invalid_type:r.received===w.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case y.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,N.jsonStringifyReplacer)}`;break;case y.unrecognized_keys:t=`Unrecognized key(s) in object: ${N.joinValues(r.keys,", ")}`;break;case y.invalid_union:t="Invalid input";break;case y.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${N.joinValues(r.options)}`;break;case y.invalid_enum_value:t=`Invalid enum value. Expected ${N.joinValues(r.options)}, received '${r.received}'`;break;case y.invalid_arguments:t="Invalid function arguments";break;case y.invalid_return_type:t="Invalid function return type";break;case y.invalid_date:t="Invalid date";break;case y.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:N.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case y.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case y.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case y.custom:t="Invalid input";break;case y.invalid_intersection_types:t="Intersection results could not be merged";break;case y.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case y.not_finite:t="Number must be finite";break;default:t=e.defaultError,N.assertNever(r)}return{message:t}};let li=or;function Au(r){li=r}function qr(){return li}const Wr=r=>{const{data:e,path:t,errorMaps:n,issueData:a}=r,s=[...t,...a.path||[]],i={...a,path:s};let o="";const u=n.filter(c=>!!c).slice().reverse();for(const c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:a.message||o}},Eu=[];function A(r,e){const t=Wr({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,qr(),or].filter(n=>!!n)});r.common.issues.push(t)}class ae{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const a of t){if(a.status==="aborted")return P;a.status==="dirty"&&e.dirty(),n.push(a.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const a of t)n.push({key:await a.key,value:await a.value});return ae.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const a of t){const{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return P;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||a.alwaysSet)&&(n[s.value]=i.value)}return{status:e.value,value:n}}}const P=Object.freeze({status:"aborted"}),di=r=>({status:"dirty",value:r}),ie=r=>({status:"valid",value:r}),fa=r=>r.status==="aborted",ma=r=>r.status==="dirty",ur=r=>r.status==="valid",Kr=r=>typeof Promise<"u"&&r instanceof Promise;var O;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(O||(O={}));class Ne{constructor(e,t,n,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const vs=(r,e)=>{if(ur(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Te(r.common.issues);return this._error=t,this._error}}};function T(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:a}=r;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>i.code!=="invalid_type"?{message:o.defaultError}:typeof o.data>"u"?{message:n??o.defaultError}:{message:t??o.defaultError},description:a}}class C{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return et(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:et(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ae,ctx:{common:e.parent.common,data:e.data,parsedType:et(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Kr(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const a={common:{issues:[],async:(n=t==null?void 0:t.async)!==null&&n!==void 0?n:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:et(e)},s=this._parseSync({data:e,path:a.path,parent:a});return vs(a,s)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:et(e)},a=this._parse({data:e,path:n.path,parent:n}),s=await(Kr(a)?a:Promise.resolve(a));return vs(n,s)}refine(e,t){const n=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{const i=e(a),o=()=>s.addIssue({code:y.custom,...n(a)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,a)=>e(n)?!0:(a.addIssue(typeof t=="function"?t(n,a):t),!1))}_refinement(e){return new fe({schema:this,typeName:g.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return xe.create(this,this._def)}nullable(){return He.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return le.create(this,this._def)}promise(){return zt.create(this,this._def)}or(e){return st.create([this,e],this._def)}and(e){return it.create(this,e,this._def)}transform(e){return new fe({...T(this._def),schema:this,typeName:g.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new ot({...T(this._def),innerType:this,defaultValue:t,typeName:g.ZodDefault})}brand(){return new fi({typeName:g.ZodBranded,type:this,...T(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Ht({...T(this._def),innerType:this,catchValue:t,typeName:g.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return ut.create(this,e)}readonly(){return Yr.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Ou=/^c[^\s-]{8,}$/i,Pu=/^[a-z][a-z0-9]*$/,ku=/^[0-9A-HJKMNP-TV-Z]{26}$/,Tu=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Su=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Cu="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Hn;const Iu=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,Ru=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Nu=r=>r.precision?r.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${r.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${r.precision}}Z$`):r.precision===0?r.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):r.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function ju(r,e){return!!((e==="v4"||!e)&&Iu.test(r)||(e==="v6"||!e)&&Ru.test(r))}class ye extends C{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==w.string){const s=this._getOrReturnCtx(e);return A(s,{code:y.invalid_type,expected:w.string,received:s.parsedType}),P}const n=new ae;let a;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:y.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:y.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="length"){const i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?A(a,{code:y.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&A(a,{code:y.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),n.dirty())}else if(s.kind==="email")Su.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"email",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="emoji")Hn||(Hn=new RegExp(Cu,"u")),Hn.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"emoji",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="uuid")Tu.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"uuid",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid")Ou.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid2")Pu.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"cuid2",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="ulid")ku.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ulid",code:y.invalid_string,message:s.message}),n.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),A(a,{validation:"url",code:y.invalid_string,message:s.message}),n.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"regex",code:y.invalid_string,message:s.message}),n.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),A(a,{code:y.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),n.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:y.invalid_string,validation:{startsWith:s.value},message:s.message}),n.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),A(a,{code:y.invalid_string,validation:{endsWith:s.value},message:s.message}),n.dirty()):s.kind==="datetime"?Nu(s).test(e.data)||(a=this._getOrReturnCtx(e,a),A(a,{code:y.invalid_string,validation:"datetime",message:s.message}),n.dirty()):s.kind==="ip"?ju(e.data,s.version)||(a=this._getOrReturnCtx(e,a),A(a,{validation:"ip",code:y.invalid_string,message:s.message}),n.dirty()):N.assertNever(s);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(a=>e.test(a),{validation:t,code:y.invalid_string,...O.errToObj(n)})}_addCheck(e){return new ye({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...O.errToObj(e)})}url(e){return this._addCheck({kind:"url",...O.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...O.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...O.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...O.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...O.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...O.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...O.errToObj(e)})}datetime(e){var t;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,...O.errToObj(e==null?void 0:e.message)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...O.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...O.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...O.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...O.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...O.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...O.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...O.errToObj(t)})}nonempty(e){return this.min(1,O.errToObj(e))}trim(){return new ye({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ye({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ye({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ye.create=r=>{var e;return new ye({checks:[],typeName:g.ZodString,coerce:(e=r==null?void 0:r.coerce)!==null&&e!==void 0?e:!1,...T(r)})};function $u(r,e){const t=(r.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,a=t>n?t:n,s=parseInt(r.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}class je extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==w.number){const s=this._getOrReturnCtx(e);return A(s,{code:y.invalid_type,expected:w.number,received:s.parsedType}),P}let n;const a=new ae;for(const s of this._def.checks)s.kind==="int"?N.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),A(n,{code:y.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?$u(e.data,s.value)!==0&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),A(n,{code:y.not_finite,message:s.message}),a.dirty()):N.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,O.toString(t))}gt(e,t){return this.setLimit("min",e,!1,O.toString(t))}lte(e,t){return this.setLimit("max",e,!0,O.toString(t))}lt(e,t){return this.setLimit("max",e,!1,O.toString(t))}setLimit(e,t,n,a){return new je({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:O.toString(a)}]})}_addCheck(e){return new je({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:O.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:O.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:O.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:O.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:O.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:O.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:O.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:O.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:O.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&N.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}je.create=r=>new je({checks:[],typeName:g.ZodNumber,coerce:(r==null?void 0:r.coerce)||!1,...T(r)});class Ve extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==w.bigint){const s=this._getOrReturnCtx(e);return A(s,{code:y.invalid_type,expected:w.bigint,received:s.parsedType}),P}let n;const a=new ae;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),A(n,{code:y.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):N.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,O.toString(t))}gt(e,t){return this.setLimit("min",e,!1,O.toString(t))}lte(e,t){return this.setLimit("max",e,!0,O.toString(t))}lt(e,t){return this.setLimit("max",e,!1,O.toString(t))}setLimit(e,t,n,a){return new Ve({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:O.toString(a)}]})}_addCheck(e){return new Ve({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:O.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:O.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:O.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:O.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:O.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Ve.create=r=>{var e;return new Ve({checks:[],typeName:g.ZodBigInt,coerce:(e=r==null?void 0:r.coerce)!==null&&e!==void 0?e:!1,...T(r)})};class Ut extends C{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==w.boolean){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.boolean,received:n.parsedType}),P}return ie(e.data)}}Ut.create=r=>new Ut({typeName:g.ZodBoolean,coerce:(r==null?void 0:r.coerce)||!1,...T(r)});class at extends C{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==w.date){const s=this._getOrReturnCtx(e);return A(s,{code:y.invalid_type,expected:w.date,received:s.parsedType}),P}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return A(s,{code:y.invalid_date}),P}const n=new ae;let a;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:y.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),n.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),A(a,{code:y.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),n.dirty()):N.assertNever(s);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new at({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:O.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:O.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}at.create=r=>new at({checks:[],coerce:(r==null?void 0:r.coerce)||!1,typeName:g.ZodDate,...T(r)});class Jr extends C{_parse(e){if(this._getType(e)!==w.symbol){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.symbol,received:n.parsedType}),P}return ie(e.data)}}Jr.create=r=>new Jr({typeName:g.ZodSymbol,...T(r)});class cr extends C{_parse(e){if(this._getType(e)!==w.undefined){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.undefined,received:n.parsedType}),P}return ie(e.data)}}cr.create=r=>new cr({typeName:g.ZodUndefined,...T(r)});class lr extends C{_parse(e){if(this._getType(e)!==w.null){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.null,received:n.parsedType}),P}return ie(e.data)}}lr.create=r=>new lr({typeName:g.ZodNull,...T(r)});class _t extends C{constructor(){super(...arguments),this._any=!0}_parse(e){return ie(e.data)}}_t.create=r=>new _t({typeName:g.ZodAny,...T(r)});class gt extends C{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ie(e.data)}}gt.create=r=>new gt({typeName:g.ZodUnknown,...T(r)});class ze extends C{_parse(e){const t=this._getOrReturnCtx(e);return A(t,{code:y.invalid_type,expected:w.never,received:t.parsedType}),P}}ze.create=r=>new ze({typeName:g.ZodNever,...T(r)});class Gr extends C{_parse(e){if(this._getType(e)!==w.undefined){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.void,received:n.parsedType}),P}return ie(e.data)}}Gr.create=r=>new Gr({typeName:g.ZodVoid,...T(r)});class le extends C{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),a=this._def;if(t.parsedType!==w.array)return A(t,{code:y.invalid_type,expected:w.array,received:t.parsedType}),P;if(a.exactLength!==null){const i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(A(t,{code:i?y.too_big:y.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),n.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(A(t,{code:y.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),n.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(A(t,{code:y.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Ne(t,i,t.path,o)))).then(i=>ae.mergeArray(n,i));const s=[...t.data].map((i,o)=>a.type._parseSync(new Ne(t,i,t.path,o)));return ae.mergeArray(n,s)}get element(){return this._def.type}min(e,t){return new le({...this._def,minLength:{value:e,message:O.toString(t)}})}max(e,t){return new le({...this._def,maxLength:{value:e,message:O.toString(t)}})}length(e,t){return new le({...this._def,exactLength:{value:e,message:O.toString(t)}})}nonempty(e){return this.min(1,e)}}le.create=(r,e)=>new le({type:r,minLength:null,maxLength:null,exactLength:null,typeName:g.ZodArray,...T(e)});function Pt(r){if(r instanceof U){const e={};for(const t in r.shape){const n=r.shape[t];e[t]=xe.create(Pt(n))}return new U({...r._def,shape:()=>e})}else return r instanceof le?new le({...r._def,type:Pt(r.element)}):r instanceof xe?xe.create(Pt(r.unwrap())):r instanceof He?He.create(Pt(r.unwrap())):r instanceof be?be.create(r.items.map(e=>Pt(e))):r}class U extends C{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=N.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==w.object){const c=this._getOrReturnCtx(e);return A(c,{code:y.invalid_type,expected:w.object,received:c.parsedType}),P}const{status:n,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof ze&&this._def.unknownKeys==="strip"))for(const c in a.data)i.includes(c)||o.push(c);const u=[];for(const c of i){const l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Ne(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof ze){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(A(a,{code:y.unrecognized_keys,keys:o}),n.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of o){const d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Ne(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of u){const d=await l.key;c.push({key:d,value:await l.value,alwaysSet:l.alwaysSet})}return c}).then(c=>ae.mergeObjectSync(n,c)):ae.mergeObjectSync(n,u)}get shape(){return this._def.shape()}strict(e){return O.errToObj,new U({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var a,s,i,o;const u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,n).message)!==null&&i!==void 0?i:n.defaultError;return t.code==="unrecognized_keys"?{message:(o=O.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new U({...this._def,unknownKeys:"strip"})}passthrough(){return new U({...this._def,unknownKeys:"passthrough"})}extend(e){return new U({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new U({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:g.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new U({...this._def,catchall:e})}pick(e){const t={};return N.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new U({...this._def,shape:()=>t})}omit(e){const t={};return N.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new U({...this._def,shape:()=>t})}deepPartial(){return Pt(this)}partial(e){const t={};return N.objectKeys(this.shape).forEach(n=>{const a=this.shape[n];e&&!e[n]?t[n]=a:t[n]=a.optional()}),new U({...this._def,shape:()=>t})}required(e){const t={};return N.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let s=this.shape[n];for(;s instanceof xe;)s=s._def.innerType;t[n]=s}}),new U({...this._def,shape:()=>t})}keyof(){return hi(N.objectKeys(this.shape))}}U.create=(r,e)=>new U({shape:()=>r,unknownKeys:"strip",catchall:ze.create(),typeName:g.ZodObject,...T(e)});U.strictCreate=(r,e)=>new U({shape:()=>r,unknownKeys:"strict",catchall:ze.create(),typeName:g.ZodObject,...T(e)});U.lazycreate=(r,e)=>new U({shape:r,unknownKeys:"strip",catchall:ze.create(),typeName:g.ZodObject,...T(e)});class st extends C{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function a(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=s.map(o=>new Te(o.ctx.common.issues));return A(t,{code:y.invalid_union,unionErrors:i}),P}if(t.common.async)return Promise.all(n.map(async s=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s;const i=[];for(const u of n){const c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const o=i.map(u=>new Te(u));return A(t,{code:y.invalid_union,unionErrors:o}),P}}get options(){return this._def.options}}st.create=(r,e)=>new st({options:r,typeName:g.ZodUnion,...T(e)});const Lr=r=>r instanceof Bt?Lr(r.schema):r instanceof fe?Lr(r.innerType()):r instanceof Zt?[r.value]:r instanceof $e?r.options:r instanceof Vt?Object.keys(r.enum):r instanceof ot?Lr(r._def.innerType):r instanceof cr?[void 0]:r instanceof lr?[null]:null;class vt extends C{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.object)return A(t,{code:y.invalid_type,expected:w.object,received:t.parsedType}),P;const n=this.discriminator,a=t.data[n],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(A(t,{code:y.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),P)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const a=new Map;for(const s of t){const i=Lr(s.shape[e]);if(!i)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new vt({typeName:g.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...T(n)})}}function pa(r,e){const t=et(r),n=et(e);if(r===e)return{valid:!0,data:r};if(t===w.object&&n===w.object){const a=N.objectKeys(e),s=N.objectKeys(r).filter(o=>a.indexOf(o)!==-1),i={...r,...e};for(const o of s){const u=pa(r[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===w.array&&n===w.array){if(r.length!==e.length)return{valid:!1};const a=[];for(let s=0;s<r.length;s++){const i=r[s],o=e[s],u=pa(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===w.date&&n===w.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class it extends C{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),a=(s,i)=>{if(fa(s)||fa(i))return P;const o=pa(s.value,i.value);return o.valid?((ma(s)||ma(i))&&t.dirty(),{status:t.value,value:o.data}):(A(n,{code:y.invalid_intersection_types}),P)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}it.create=(r,e,t)=>new it({left:r,right:e,typeName:g.ZodIntersection,...T(t)});class be extends C{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==w.array)return A(n,{code:y.invalid_type,expected:w.array,received:n.parsedType}),P;if(n.data.length<this._def.items.length)return A(n,{code:y.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),P;!this._def.rest&&n.data.length>this._def.items.length&&(A(n,{code:y.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((i,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Ne(n,i,n.path,o)):null}).filter(i=>!!i);return n.common.async?Promise.all(s).then(i=>ae.mergeArray(t,i)):ae.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new be({...this._def,rest:e})}}be.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new be({items:r,typeName:g.ZodTuple,rest:null,...T(e)})};class dr extends C{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==w.object)return A(n,{code:y.invalid_type,expected:w.object,received:n.parsedType}),P;const a=[],s=this._def.keyType,i=this._def.valueType;for(const o in n.data)a.push({key:s._parse(new Ne(n,o,n.path,o)),value:i._parse(new Ne(n,n.data[o],n.path,o))});return n.common.async?ae.mergeObjectAsync(t,a):ae.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof C?new dr({keyType:e,valueType:t,typeName:g.ZodRecord,...T(n)}):new dr({keyType:ye.create(),valueType:e,typeName:g.ZodRecord,...T(t)})}}class Xr extends C{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==w.map)return A(n,{code:y.invalid_type,expected:w.map,received:n.parsedType}),P;const a=this._def.keyType,s=this._def.valueType,i=[...n.data.entries()].map(([o,u],c)=>({key:a._parse(new Ne(n,o,n.path,[c,"key"])),value:s._parse(new Ne(n,u,n.path,[c,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of i){const c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return P;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of i){const c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return P;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}}Xr.create=(r,e,t)=>new Xr({valueType:e,keyType:r,typeName:g.ZodMap,...T(t)});class wt extends C{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==w.set)return A(n,{code:y.invalid_type,expected:w.set,received:n.parsedType}),P;const a=this._def;a.minSize!==null&&n.data.size<a.minSize.value&&(A(n,{code:y.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&n.data.size>a.maxSize.value&&(A(n,{code:y.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const s=this._def.valueType;function i(u){const c=new Set;for(const l of u){if(l.status==="aborted")return P;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}const o=[...n.data.values()].map((u,c)=>s._parse(new Ne(n,u,n.path,c)));return n.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new wt({...this._def,minSize:{value:e,message:O.toString(t)}})}max(e,t){return new wt({...this._def,maxSize:{value:e,message:O.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}wt.create=(r,e)=>new wt({valueType:r,minSize:null,maxSize:null,typeName:g.ZodSet,...T(e)});class jt extends C{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.function)return A(t,{code:y.invalid_type,expected:w.function,received:t.parsedType}),P;function n(o,u){return Wr({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,qr(),or].filter(c=>!!c),issueData:{code:y.invalid_arguments,argumentsError:u}})}function a(o,u){return Wr({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,qr(),or].filter(c=>!!c),issueData:{code:y.invalid_return_type,returnTypeError:u}})}const s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof zt){const o=this;return ie(async function(...u){const c=new Te([]),l=await o._def.args.parseAsync(u,s).catch(m=>{throw c.addIssue(n(u,m)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(m=>{throw c.addIssue(a(d,m)),c})})}else{const o=this;return ie(function(...u){const c=o._def.args.safeParse(u,s);if(!c.success)throw new Te([n(u,c.error)]);const l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new Te([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new jt({...this._def,args:be.create(e).rest(gt.create())})}returns(e){return new jt({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new jt({args:e||be.create([]).rest(gt.create()),returns:t||gt.create(),typeName:g.ZodFunction,...T(n)})}}class Bt extends C{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Bt.create=(r,e)=>new Bt({getter:r,typeName:g.ZodLazy,...T(e)});class Zt extends C{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:y.invalid_literal,expected:this._def.value}),P}return{status:"valid",value:e.data}}get value(){return this._def.value}}Zt.create=(r,e)=>new Zt({value:r,typeName:g.ZodLiteral,...T(e)});function hi(r,e){return new $e({values:r,typeName:g.ZodEnum,...T(e)})}class $e extends C{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return A(t,{expected:N.joinValues(n),received:t.parsedType,code:y.invalid_type}),P}if(this._def.values.indexOf(e.data)===-1){const t=this._getOrReturnCtx(e),n=this._def.values;return A(t,{received:t.data,code:y.invalid_enum_value,options:n}),P}return ie(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e){return $e.create(e)}exclude(e){return $e.create(this.options.filter(t=>!e.includes(t)))}}$e.create=hi;class Vt extends C{_parse(e){const t=N.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==w.string&&n.parsedType!==w.number){const a=N.objectValues(t);return A(n,{expected:N.joinValues(a),received:n.parsedType,code:y.invalid_type}),P}if(t.indexOf(e.data)===-1){const a=N.objectValues(t);return A(n,{received:n.data,code:y.invalid_enum_value,options:a}),P}return ie(e.data)}get enum(){return this._def.values}}Vt.create=(r,e)=>new Vt({values:r,typeName:g.ZodNativeEnum,...T(e)});class zt extends C{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.promise&&t.common.async===!1)return A(t,{code:y.invalid_type,expected:w.promise,received:t.parsedType}),P;const n=t.parsedType===w.promise?t.data:Promise.resolve(t.data);return ie(n.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}zt.create=(r,e)=>new zt({type:r,typeName:g.ZodPromise,...T(e)});class fe extends C{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===g.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{A(n,i),i.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){const i=a.transform(n.data,s);return n.common.issues.length?{status:"dirty",value:n.data}:n.common.async?Promise.resolve(i).then(o=>this._def.schema._parseAsync({data:o,path:n.path,parent:n})):this._def.schema._parseSync({data:i,path:n.path,parent:n})}if(a.type==="refinement"){const i=o=>{const u=a.refinement(o,s);if(n.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?P:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?P:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(n.common.async===!1){const i=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!ur(i))return i;const o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(i=>ur(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);N.assertNever(a)}}fe.create=(r,e,t)=>new fe({schema:r,typeName:g.ZodEffects,effect:e,...T(t)});fe.createWithPreprocess=(r,e,t)=>new fe({schema:e,effect:{type:"preprocess",transform:r},typeName:g.ZodEffects,...T(t)});class xe extends C{_parse(e){return this._getType(e)===w.undefined?ie(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}xe.create=(r,e)=>new xe({innerType:r,typeName:g.ZodOptional,...T(e)});class He extends C{_parse(e){return this._getType(e)===w.null?ie(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}He.create=(r,e)=>new He({innerType:r,typeName:g.ZodNullable,...T(e)});class ot extends C{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===w.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}ot.create=(r,e)=>new ot({innerType:r,typeName:g.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...T(e)});class Ht extends C{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Kr(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Te(n.common.issues)},input:n.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new Te(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Ht.create=(r,e)=>new Ht({innerType:r,typeName:g.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...T(e)});class Qr extends C{_parse(e){if(this._getType(e)!==w.nan){const n=this._getOrReturnCtx(e);return A(n,{code:y.invalid_type,expected:w.nan,received:n.parsedType}),P}return{status:"valid",value:e.data}}}Qr.create=r=>new Qr({typeName:g.ZodNaN,...T(r)});const Lu=Symbol("zod_brand");class fi extends C{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class ut extends C{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?P:s.status==="dirty"?(t.dirty(),di(s.value)):this._def.out._parseAsync({data:s.value,path:n.path,parent:n})})();{const a=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?P:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:n.path,parent:n})}}static create(e,t){return new ut({in:e,out:t,typeName:g.ZodPipeline})}}class Yr extends C{_parse(e){const t=this._def.innerType._parse(e);return ur(t)&&(t.value=Object.freeze(t.value)),t}}Yr.create=(r,e)=>new Yr({innerType:r,typeName:g.ZodReadonly,...T(e)});const mi=(r,e={},t)=>r?_t.create().superRefine((n,a)=>{var s,i;if(!r(n)){const o=typeof e=="function"?e(n):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):_t.create(),Mu={object:U.lazycreate};var g;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(g||(g={}));const Du=(r,e={message:`Input not instance of ${r.name}`})=>mi(t=>t instanceof r,e),pi=ye.create,gi=je.create,Fu=Qr.create,Uu=Ve.create,yi=Ut.create,Bu=at.create,Zu=Jr.create,Vu=cr.create,zu=lr.create,Ie=_t.create,Hu=gt.create,qu=ze.create,Wu=Gr.create,Ku=le.create,Ju=U.create,Gu=U.strictCreate,Xu=st.create,Qu=vt.create,Yu=it.create,ec=be.create,tc=dr.create,rc=Xr.create,nc=wt.create,ac=jt.create,bi=Bt.create,sc=Zt.create,ic=$e.create,oc=Vt.create,uc=zt.create,ws=fe.create,cc=xe.create,lc=He.create,dc=fe.createWithPreprocess,hc=ut.create,fc=()=>pi().optional(),mc=()=>gi().optional(),pc=()=>yi().optional(),gc={string:r=>ye.create({...r,coerce:!0}),number:r=>je.create({...r,coerce:!0}),boolean:r=>Ut.create({...r,coerce:!0}),bigint:r=>Ve.create({...r,coerce:!0}),date:r=>at.create({...r,coerce:!0})},yc=P;var xs=Object.freeze({__proto__:null,defaultErrorMap:or,setErrorMap:Au,getErrorMap:qr,makeIssue:Wr,EMPTY_PATH:Eu,addIssueToContext:A,ParseStatus:ae,INVALID:P,DIRTY:di,OK:ie,isAborted:fa,isDirty:ma,isValid:ur,isAsync:Kr,get util(){return N},get objectUtil(){return ha},ZodParsedType:w,getParsedType:et,ZodType:C,ZodString:ye,ZodNumber:je,ZodBigInt:Ve,ZodBoolean:Ut,ZodDate:at,ZodSymbol:Jr,ZodUndefined:cr,ZodNull:lr,ZodAny:_t,ZodUnknown:gt,ZodNever:ze,ZodVoid:Gr,ZodArray:le,ZodObject:U,ZodUnion:st,ZodDiscriminatedUnion:vt,ZodIntersection:it,ZodTuple:be,ZodRecord:dr,ZodMap:Xr,ZodSet:wt,ZodFunction:jt,ZodLazy:Bt,ZodLiteral:Zt,ZodEnum:$e,ZodNativeEnum:Vt,ZodPromise:zt,ZodEffects:fe,ZodTransformer:fe,ZodOptional:xe,ZodNullable:He,ZodDefault:ot,ZodCatch:Ht,ZodNaN:Qr,BRAND:Lu,ZodBranded:fi,ZodPipeline:ut,ZodReadonly:Yr,custom:mi,Schema:C,ZodSchema:C,late:Mu,get ZodFirstPartyTypeKind(){return g},coerce:gc,any:Ie,array:Ku,bigint:Uu,boolean:yi,date:Bu,discriminatedUnion:Qu,effect:ws,enum:ic,function:ac,instanceof:Du,intersection:Yu,lazy:bi,literal:sc,map:rc,nan:Fu,nativeEnum:oc,never:qu,null:zu,nullable:lc,number:gi,object:Ju,oboolean:pc,onumber:mc,optional:cc,ostring:fc,pipeline:hc,preprocess:dc,promise:uc,record:tc,set:nc,strictObject:Gu,string:pi,symbol:Zu,transformer:ws,tuple:ec,undefined:Vu,union:Xu,unknown:Hu,void:Wu,NEVER:yc,ZodIssueCode:y,quotelessJson:xu,ZodError:Te}),bc=["required","minLength","maxLength","min","max","step","multiple","pattern"];function _c(r){function e(n,a){var s,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"",o=i!==""?(s=a[i])!==null&&s!==void 0?s:a[i]={required:!0}:{};if(n instanceof U)for(var u in n.shape)e(n.shape[u],a,i?"".concat(i,".").concat(u):u);else if(n instanceof fe)e(n.innerType(),a,i);else if(n instanceof ut)e(n._def.out,a,i);else if(n instanceof it){var c={},l={};e(n._def.left,c,i),e(n._def.right,l,i),Object.assign(a,c,l)}else if(n instanceof st||n instanceof vt)Object.assign(a,n.options.map(h=>{var m={};return e(h,m,i),m}).reduce((h,m)=>{var f=new Set([...Object.keys(h),...Object.keys(m)]),v={};for(var p of f){var E=h[p],k=m[p];if(E&&k){var I={};v[p]=I;for(var B of bc)typeof E[B]<"u"&&typeof k[B]<"u"&&E[B]===k[B]&&(I[B]=E[B])}else v[p]=D(D(D({},E),k),{},{required:!1})}return v}));else{if(i==="")throw new Error("Unsupported schema");if(n instanceof le)o.multiple=!0,e(n.element,a,"".concat(i,"[]"));else if(n instanceof ye)n.minLength!==null&&(o.minLength=n.minLength),n.maxLength!==null&&(o.maxLength=n.maxLength);else if(n instanceof xe)o.required=!1,e(n.unwrap(),a,i);else if(n instanceof ot)o.required=!1,e(n.removeDefault(),a,i);else if(n instanceof je)n.minValue!==null&&(o.min=n.minValue),n.maxValue!==null&&(o.max=n.maxValue);else if(n instanceof $e)o.pattern=n.options.map(h=>h.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")).join("|");else if(n instanceof be)for(var d=0;d<n.items.length;d++)e(n.items[d],a,"".concat(i,"[").concat(d,"]"))}}var t={};return e(r,t),t}function lt(r,e){if(typeof r!="string")return r;if(r!=="")return typeof e!="function"?r:e(r)}function Tr(r){if(!(typeof File<"u"&&r instanceof File&&r.name===""&&r.size===0))return r}function vc(r){return typeof File>"u"?!1:r._def.effect.type==="refinement"&&r.innerType()instanceof _t&&r.safeParse(new File([],"")).success&&!r.safeParse("").success}function Q(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:new Map,t=e.get(r);if(t)return t;var n=r;if(r instanceof ye||r instanceof Zt||r instanceof $e||r instanceof Vt)n=Ie().transform(s=>lt(s)).pipe(r);else if(r instanceof je)n=Ie().transform(s=>lt(s,i=>i.trim()===""?Number.NaN:Number(i))).pipe(r);else if(r instanceof Ut)n=Ie().transform(s=>lt(s,i=>i==="on"?!0:i)).pipe(r);else if(r instanceof at)n=Ie().transform(s=>lt(s,i=>{var o=new Date(i);return isNaN(o.getTime())?i:o})).pipe(r);else if(r instanceof Ve)n=Ie().transform(s=>lt(s,BigInt)).pipe(r);else if(r instanceof le)n=Ie().transform(s=>Array.isArray(s)?s:typeof s>"u"||typeof Tr(s)>"u"?[]:[s]).pipe(new le(D(D({},r._def),{},{type:Q(r.element,e)})));else if(r instanceof U){var a=Object.fromEntries(Object.entries(r.shape).map(s=>{var[i,o]=s;return[i,Q(o,e)]}));n=new U(D(D({},r._def),{},{shape:()=>a}))}else r instanceof fe?vc(r)?n=Ie().transform(s=>Tr(s)).pipe(r):n=new fe(D(D({},r._def),{},{schema:Q(r.innerType(),e)})):r instanceof xe?n=Ie().transform(s=>Tr(lt(s))).pipe(new xe(D(D({},r._def),{},{innerType:Q(r.unwrap(),e)}))):r instanceof ot?n=Ie().transform(s=>Tr(lt(s))).pipe(new ot(D(D({},r._def),{},{innerType:Q(r.removeDefault(),e)}))):r instanceof Ht?n=new Ht(D(D({},r._def),{},{innerType:Q(r.removeCatch(),e)})):r instanceof it?n=new it(D(D({},r._def),{},{left:Q(r._def.left,e),right:Q(r._def.right,e)})):r instanceof st?n=new st(D(D({},r._def),{},{options:r.options.map(s=>Q(s,e))})):r instanceof vt?n=new vt(D(D({},r._def),{},{options:r.options.map(s=>Q(s,e)),optionsMap:new Map(Array.from(r.optionsMap.entries()).map(s=>{var[i,o]=s;return[i,Q(o,e)]}))})):r instanceof be?n=new be(D(D({},r._def),{},{items:r.items.map(s=>Q(s,e))})):r instanceof He?n=new He(D(D({},r._def),{},{innerType:Q(r.unwrap(),e)})):r instanceof ut?n=new ut(D(D({},r._def),{},{in:Q(r._def.in,e),out:Q(r._def.out,e)})):r instanceof Bt&&(n=bi(()=>Q(r.schema,e)));return r!==n&&e.set(r,n),n}function wc(r,e){var t={};for(var n of r.errors){var a=bt(n.path);switch(n.message){case As.VALIDATION_UNDEFINED:return null;case As.VALIDATION_SKIPPED:t[a]=null;break;default:{var s=t[a];s!==null&&(s?t[a]=s.concat(n):t[a]=[n]);break}}}return Object.entries(t).reduce((i,o)=>{var[u,c]=o;return i[u]=c?e(c):null,i},{})}function _i(r,e){return qo(r,{resolve(t,n){var a=e.errorMap,s=Q(typeof e.schema=="function"?e.schema(n):e.schema),i=o=>{var u;return{value:o.success?o.data:void 0,error:o.success?void 0:wc(o.error,(u=e.formatError)!==null&&u!==void 0?u:c=>c.map(l=>l.message))}};return e.async?s.safeParseAsync(t,{errorMap:a}).then(o=>i(o)):i(s.safeParse(t,{errorMap:a}))}})}var As={VALIDATION_SKIPPED:"__skipped__",VALIDATION_UNDEFINED:"__undefined__"};const vi=H.forwardRef(({className:r,disabled:e,disableOnFormSubmission:t,...n},a)=>{const s=Vr.useFormStatus(),i=e||t&&(s==null?void 0:s.pending);return F.jsx("textarea",{className:ti("flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",r),ref:a,disabled:i,...n})});vi.displayName="Textarea";const xc=H.forwardRef((r,e)=>H.createElement(Co.label,Io({},r,{ref:e,onMouseDown:t=>{var n;(n=r.onMouseDown)===null||n===void 0||n.call(r,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault()}}))),wi=xc,Ac=Ro("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),xi=H.forwardRef(({className:r,...e},t)=>F.jsx(wi,{ref:t,className:ti(Ac(),r),...e}));xi.displayName=wi.displayName;let Es=!1;function Ec(r,e){const t=Oo(),n=Po(),a=ei(),s=ko(),[i,o]=H.useState(Es),u=H.useRef([]);if(H.useEffect(()=>{i||(Es=!0,o(!0))},[i]),H.useEffect(()=>()=>{for(const d of u.current)d.reject(new Error("Form was unmounted."));u.current=[]},[]),a.state==="idle"&&typeof n<"u"){for(const d of u.current)d.resolve(n);u.current=[]}const[c,l]=Vr.useFormState(async(d,h)=>{await(r==null?void 0:r(h));const f=await new Promise((v,p)=>{u.current.push({resolve:v,reject:p}),s(h,{method:"POST",action:t,encType:"multipart/form-data",replace:!0,unstable_viewTransition:!0,unstable_flushSync:!0})});return await(e==null?void 0:e(f)),f},n);return[i?{action:l}:{action:t,encType:"multipart/form-data",method:"POST"},c]}var Oc=function(r,e){if(typeof r!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,r.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const Pc=Ra(Oc);var Ai={exports:{}};const kc=/[\p{Lu}]/u,Tc=/[\p{Ll}]/u,Os=/^[\p{Lu}](?![\p{Lu}])/gu,Ei=/([\p{Alpha}\p{N}_]|$)/u,Oi=/[_.\- ]+/,Sc=new RegExp("^"+Oi.source),Ps=new RegExp(Oi.source+Ei.source,"gu"),ks=new RegExp("\\d+"+Ei.source,"gu"),Cc=(r,e,t)=>{let n=!1,a=!1,s=!1;for(let i=0;i<r.length;i++){const o=r[i];n&&kc.test(o)?(r=r.slice(0,i)+"-"+r.slice(i),n=!1,s=a,a=!0,i++):a&&s&&Tc.test(o)?(r=r.slice(0,i-1)+"-"+r.slice(i-1),s=a,a=!1,n=!0):(n=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return r},Ic=(r,e)=>(Os.lastIndex=0,r.replace(Os,t=>e(t))),Rc=(r,e)=>(Ps.lastIndex=0,ks.lastIndex=0,r.replace(Ps,(t,n)=>e(n)).replace(ks,t=>e(t))),Pi=(r,e)=>{if(!(typeof r=="string"||Array.isArray(r)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(r)?r=r.map(s=>s.trim()).filter(s=>s.length).join("-"):r=r.trim(),r.length===0)return"";const t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),n=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return r.length===1?e.pascalCase?n(r):t(r):(r!==t(r)&&(r=Cc(r,t,n)),r=r.replace(Sc,""),e.preserveConsecutiveUppercase?r=Ic(r,t):r=t(r),e.pascalCase&&(r=n(r.charAt(0))+r.slice(1)),Rc(r,n))};Ai.exports=Pi;Ai.exports.default=Pi;function Nc(r,e){return(e==null?void 0:e[r])||Pc(r)}function jc(r,e,t){const n={};for(const a in r)Object.hasOwn(r,a)&&(n[e(a,t)]=r[a]);return n}function Ts(r){return Array.isArray(r)?[...r]:{...r}}function $c(r,e){const t=Ts(r);for(const[n,a]of Object.entries(e)){const[s,...i]=n.split(".").reverse();let o=t;for(const u of i.reverse()){if(o[u]===void 0)break;o[u]=Ts(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function ki(r){const e=Object.getPrototypeOf(r);return typeof r.lc_name=="function"&&(typeof e.lc_name!="function"||r.lc_name()!==e.lc_name())?r.lc_name():r.name}class xt{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ki(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof xt||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(n,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=n;const[o,...u]=a.split(".").reverse();for(const c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:jc(Object.keys(t).length?$c(n,t):n,Nc,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function Wt(r,e){return typeof r=="string"?typeof e=="string"?r+e:[{type:"text",text:r},...e]:Array.isArray(e)?[...r,...e]:[...r,{type:"text",text:e}]}class Ar extends xt{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new fr({...this});if(e==="ai")return new mr({...this});if(e==="system")return new pr({...this});if(e==="function")return new gr({...this});if(Er.isInstance(this))return new yr({...this});throw new Error("Unknown message type.")}}function Ss(r){return Array.isArray(r)&&r.every(e=>typeof e.index=="number")}class Kt extends Ar{static _mergeAdditionalKwargs(e,t){var a,s;const n={...e};for(const[i,o]of Object.entries(t))if(n[i]===void 0)n[i]=o;else{if(typeof n[i]!=typeof o)throw new Error(`additional_kwargs[${i}] already exists in the message chunk, but with a different type.`);if(typeof n[i]=="string")n[i]=n[i]+o;else if(!Array.isArray(n[i])&&typeof n[i]=="object")n[i]=this._mergeAdditionalKwargs(n[i],o);else if(i==="tool_calls"&&Ss(n[i])&&Ss(o))for(const u of o)((a=n[i])==null?void 0:a[u.index])!==void 0?n[i]=(s=n[i])==null?void 0:s.map((c,l)=>l!==u.index?c:{...c,...u,function:{name:u.function.name??c.function.name,arguments:(c.function.arguments??"")+(u.function.arguments??"")}}):n[i][u.index]=u;else throw new Error(`additional_kwargs[${i}] already exists in this message chunk.`)}return n}}class hr extends Ar{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class fr extends Kt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new fr({content:Wt(this.content,e.content),additional_kwargs:fr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class ja extends Ar{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class mr extends Kt{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new mr({content:Wt(this.content,e.content),additional_kwargs:mr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Ti extends Ar{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class pr extends Kt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new pr({content:Wt(this.content,e.content),additional_kwargs:pr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class gr extends Kt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new gr({content:Wt(this.content,e.content),additional_kwargs:gr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class en extends Kt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new en({content:Wt(this.content,e.content),additional_kwargs:en._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),tool_call_id:this.tool_call_id})}}class Er extends Ar{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Er}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}function Lc(r){return typeof(r==null?void 0:r._getType)=="function"}function Xt(r){if(typeof r=="string")return new hr(r);if(Lc(r))return r;const[e,t]=r;if(e==="human"||e==="user")return new hr({content:t});if(e==="ai"||e==="assistant")return new ja({content:t});if(e==="system")return new Ti({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class yr extends Kt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new yr({content:Wt(this.content,e.content),additional_kwargs:yr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function Si(r,e="Human",t="AI"){const n=[];for(const a of r){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const i=a.name?`${a.name}, `:"";n.push(`${s}: ${i}${a.content}`)}return n.join(`
`)}const kt="4.26.1";let Cs=!1,ar,Ci,Ii,ga,Ri,Ni,ji,$i,Li;function Mc(r,e={auto:!1}){if(Cs)throw new Error(`you must \`import 'openai/shims/${r.kind}'\` before importing anything else from openai`);if(ar)throw new Error(`can't \`import 'openai/shims/${r.kind}'\` after \`import 'openai/shims/${ar}'\``);Cs=e.auto,ar=r.kind,Ci=r.fetch,r.Request,r.Response,r.Headers,Ii=r.FormData,r.Blob,ga=r.File,Ri=r.ReadableStream,Ni=r.getMultipartRequestOptions,ji=r.getDefaultAgent,$i=r.fileFromPath,Li=r.isFsReadStream}class Dc{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Fc({manuallyImported:r}={}){const e=r?"You may need to use polyfills":"Add one of these imports before your first `import  from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,n,a,s;try{t=fetch,n=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:a,Headers:s,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Dc(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}ar||Mc(Fc(),{auto:!0});let j=class extends Error{},me=class ya extends j{constructor(e,t,n,a){super(`${ya.makeMessage(e,t,n)}`),this.status=e,this.headers=a;const s=t;this.error=s,this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,n){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,n,a){if(!e)return new Or({cause:_a(t)});const s=t==null?void 0:t.error;return e===400?new $a(e,s,n,a):e===401?new La(e,s,n,a):e===403?new Ma(e,s,n,a):e===404?new Da(e,s,n,a):e===409?new Fa(e,s,n,a):e===422?new Ua(e,s,n,a):e===429?new Ba(e,s,n,a):e>=500?new Za(e,s,n,a):new ya(e,s,n,a)}},ct=class extends me{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},Or=class extends me{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},$n=class extends Or{constructor({message:e}={}){super({message:e??"Request timed out."})}},$a=class extends me{constructor(){super(...arguments),this.status=400}},La=class extends me{constructor(){super(...arguments),this.status=401}},Ma=class extends me{constructor(){super(...arguments),this.status=403}},Da=class extends me{constructor(){super(...arguments),this.status=404}},Fa=class extends me{constructor(){super(...arguments),this.status=409}},Ua=class extends me{constructor(){super(...arguments),this.status=422}},Ba=class extends me{constructor(){super(...arguments),this.status=429}},Za=class extends me{};const Uc=Object.freeze(Object.defineProperty({__proto__:null,APIConnectionError:Or,APIConnectionTimeoutError:$n,APIError:me,APIUserAbortError:ct,AuthenticationError:La,BadRequestError:$a,ConflictError:Fa,InternalServerError:Za,NotFoundError:Da,OpenAIError:j,PermissionDeniedError:Ma,RateLimitError:Ba,UnprocessableEntityError:Ua},Symbol.toStringTag,{value:"Module"}));class tt{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;const a=new Bc;async function*s(){if(!e.body)throw t.abort(),new j("Attempted to iterate over a response with no body");const o=new At,u=Is(e.body);for await(const c of u)for(const l of o.decode(c)){const d=a.decode(l);d&&(yield d)}for(const c of o.flush()){const l=a.decode(c);l&&(yield l)}}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(const u of s())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(c&&c.error)throw new me(void 0,c.error,void 0,void 0);yield c}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new tt(i,t)}static fromReadableStream(e,t){let n=!1;async function*a(){const i=new At,o=Is(e);for await(const u of o)for(const c of i.decode(u))yield c;for(const u of i.flush())yield u}async function*s(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(const o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new tt(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),a=s=>({next:()=>{if(s.length===0){const i=n.next();e.push(i),t.push(i)}return s.shift()}});return[new tt(()=>a(e),this.controller),new tt(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new Ri({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:s,done:i}=await t.next();if(i)return a.close();const o=n.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}}class Bc{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,a]=Zc(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}}class At{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=At.NEWLINE_CHARS.has(t[t.length-1]||"");let a=t.split(At.NEWLINE_REGEXP);return a.length===1&&!n?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),n||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new j(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new j(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new j("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}At.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);At.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function Zc(r,e){const t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}function Is(r){if(r[Symbol.asyncIterator])return r;const e=r.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Mi=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",Vc=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Di(r),Di=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",zc=r=>Vc(r)||Mi(r)||Li(r);async function Fi(r,e,t={}){var a;if(r=await r,Mi(r)){const s=await r.blob();return e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new ga([s],e,t)}const n=await Hc(r);if(e||(e=Wc(r)??"unknown_file"),!t.type){const s=(a=n[0])==null?void 0:a.type;typeof s=="string"&&(t={...t,type:s})}return new ga(n,e,t)}async function Hc(r){var t;let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Di(r))e.push(await r.arrayBuffer());else if(Kc(r))for await(const n of r)e.push(n);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${(t=r==null?void 0:r.constructor)==null?void 0:t.name}; props: ${qc(r)}`);return e}function qc(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Wc(r){var e;return qn(r.name)||qn(r.filename)||((e=qn(r.path))==null?void 0:e.split(/[\\/]/).pop())}const qn=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},Kc=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",Rs=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody",br=async r=>{const e=await Jc(r.body);return Ni(e,r)},Jc=async r=>{const e=new Ii;return await Promise.all(Object.entries(r||{}).map(([t,n])=>ba(e,t,n))),e},ba=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(zc(t)){const n=await Fi(t);r.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>ba(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,a])=>ba(r,`${e}[${n}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Mr={},Gc=function(r,e,t,n,a){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!a:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?a.call(r,t):a?a.value=t:e.set(r,t),t},Xc=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Sr;async function Ui(r){const{response:e}=r;if(r.options.stream)return $t("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):tt.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;const t=e.headers.get("content-type");if(t!=null&&t.includes("application/json")){const a=await e.json();return $t("response",e.status,e.url,e.headers,a),a}const n=await e.text();return $t("response",e.status,e.url,e.headers,n),n}class Ln extends Promise{constructor(e,t=Ui){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ln(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Qc{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Wn("maxRetries",t),this.timeout=Wn("timeout",n),this.httpAgent=a,this.fetch=s??Ci}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...al(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${ul()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(a=>({method:e,path:t,...a})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var f;const{method:t,path:n,query:a,headers:s={}}=e,i=Rs(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(n,a);"timeout"in e&&Wn("timeout",e.timeout);const c=e.timeout??this.timeout,l=e.httpAgent??this.httpAgent??ji(u),d=c+1e3;typeof((f=l==null?void 0:l.options)==null?void 0:f.timeout)=="number"&&d>(l.options.timeout??0)&&(l.options.timeout=d),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:h,...l&&{agent:l},signal:e.signal??null},url:u,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n}){const a={};n&&(a["content-length"]=n);const s=this.defaultHeaders(e);return Ls(a,s),Ls(a,t),Rs(e.body)&&ar!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,a){return me.generate(e,t,n,a)}request(e,t=null){return new Ln(this.makeRequest(e,t))}async makeRequest(e,t){var l,d;const n=await e;t==null&&(t=n.maxRetries??this.maxRetries),await this.prepareOptions(n);const{req:a,url:s,timeout:i}=this.buildRequest(n);if(await this.prepareRequest(a,{url:s,options:n}),$t("request",s,n,a.headers),(l=n.signal)!=null&&l.aborted)throw new ct;const o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(_a);if(u instanceof Error){if((d=n.signal)!=null&&d.aborted)throw new ct;if(t)return this.retryRequest(n,t);throw u.name==="AbortError"?new $n:new Or({cause:u})}const c=el(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){const E=`retrying, ${t} attempts remaining`;return $t(`response (error; ${E})`,u.status,s,c),this.retryRequest(n,t,c)}const h=await u.text().catch(E=>_a(E).message),m=sl(h),f=m?void 0:h;throw $t(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,c,f),this.makeStatusError(u.status,m,f,c)}return{response:u,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Yc(this,n,e)}buildURL(e,t){const n=ol(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Vi(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new j(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,a){const{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),n);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let a;const s=n==null?void 0:n["retry-after-ms"];if(s){const o=parseFloat(s);Number.isNaN(o)||(a=o)}const i=n==null?void 0:n["retry-after"];if(i&&!a){const o=parseFloat(i);Number.isNaN(o)?a=Date.parse(i)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Zi(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${kt}`}}class Bi{constructor(e,t,n,a){Sr.set(this,void 0),Gc(this,Sr,e,"f"),this.options=a,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new j("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,s]of n)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await Xc(this,Sr,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Sr=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Yc extends Ln{constructor(e,t,n){super(t,async a=>new n(e,a.response,await Ui(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const el=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),tl={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},Le=r=>typeof r=="object"&&r!==null&&!Vi(r)&&Object.keys(r).every(e=>zi(tl,e)),rl=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":kt,"X-Stainless-OS":js(Deno.build.os),"X-Stainless-Arch":Ns(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":kt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":kt,"X-Stainless-OS":js(process.platform),"X-Stainless-Arch":Ns(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const r=nl();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":kt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":kt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function nl(){if(typeof navigator>"u"||!navigator)return null;const r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of r){const n=t.exec(navigator.userAgent);if(n){const a=n[1]||0,s=n[2]||0,i=n[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}const Ns=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",js=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown");let $s;const al=()=>$s??($s=rl()),sl=r=>{try{return JSON.parse(r)}catch{return}},il=new RegExp("^(?:[a-z]+:)?//","i"),ol=r=>il.test(r),Zi=r=>new Promise(e=>setTimeout(e,r)),Wn=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new j(`${r} must be an integer`);if(e<0)throw new j(`${r} must be a positive integer`);return e},_a=r=>r instanceof Error?r:new Error(r),Kn=r=>{var e,t,n,a;if(typeof process<"u")return((e=Mr==null?void 0:Mr[r])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(n=(t=Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,r))==null?void 0:a.trim()};function Vi(r){if(!r)return!0;for(const e in r)return!1;return!0}function zi(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Ls(r,e){for(const t in e){if(!zi(e,t))continue;const n=t.toLowerCase();if(!n)continue;const a=e[t];a===null?delete r[n]:a!==void 0&&(r[n]=a)}}function $t(r,...e){typeof process<"u"&&Mr.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${r}`,...e)}const ul=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),cl=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";class Va extends Bi{constructor(e,t,n,a){super(e,t,n,a),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class We extends Bi{constructor(e,t,n,a){super(e,t,n,a),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var n;const e=this.getPaginatedItems();if(!e.length)return null;const t=(n=e[e.length-1])==null?void 0:n.id;return t?{params:{after:t}}:null}}class V{constructor(e){this._client=e}}let tn=class extends V{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};tn||(tn={});let rn=class extends V{constructor(){super(...arguments),this.completions=new tn(this._client)}};(function(r){r.Completions=tn})(rn||(rn={}));class nn extends V{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}nn||(nn={});class an extends V{create(e,t){return this._client.post("/audio/transcriptions",br({body:e,...t}))}}an||(an={});class sn extends V{create(e,t){return this._client.post("/audio/translations",br({body:e,...t}))}}sn||(sn={});class on extends V{constructor(){super(...arguments),this.transcriptions=new an(this._client),this.translations=new sn(this._client),this.speech=new nn(this._client)}}(function(r){r.Transcriptions=an,r.Translations=sn,r.Speech=nn})(on||(on={}));let un=class extends V{create(e,t,n){return this._client.post(`/assistants/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/assistants/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}list(e,t={},n){return Le(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,za,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}del(e,t,n){return this._client.delete(`/assistants/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}};class za extends We{}(function(r){r.AssistantFilesPage=za})(un||(un={}));class cn extends V{constructor(){super(...arguments),this.files=new un(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}list(e={},t){return Le(e)?this.list({},e):this._client.getAPIList("/assistants",Ha,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}class Ha extends We{}(function(r){r.AssistantsPage=Ha,r.Files=un,r.AssistantFilesPage=za})(cn||(cn={}));function Ms(r){return typeof r.parse=="function"}const Lt=r=>(r==null?void 0:r.role)==="assistant",Hi=r=>(r==null?void 0:r.role)==="function",qi=r=>(r==null?void 0:r.role)==="tool";var Ee=function(r,e,t,n,a){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!a:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?a.call(r,t):a?a.value=t:e.set(r,t),t},R=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},re,Dr,Fr,Qt,Yt,Ur,er,Fe,tr,Br,Zr,Tt,va,ln,wa,xa,Aa,Ea,Wi,Oa;const Ds=10;class Ki{constructor(){re.add(this),this.controller=new AbortController,Dr.set(this,void 0),Fr.set(this,()=>{}),Qt.set(this,()=>{}),Yt.set(this,void 0),Ur.set(this,()=>{}),er.set(this,()=>{}),Fe.set(this,{}),this._chatCompletions=[],this.messages=[],tr.set(this,!1),Br.set(this,!1),Zr.set(this,!1),Tt.set(this,!1),Ea.set(this,e=>{if(Ee(this,Br,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ct),e instanceof ct)return Ee(this,Zr,!0,"f"),this._emit("abort",e);if(e instanceof j)return this._emit("error",e);if(e instanceof Error){const t=new j(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new j(String(e)))}),Ee(this,Dr,new Promise((e,t)=>{Ee(this,Fr,e,"f"),Ee(this,Qt,t,"f")}),"f"),Ee(this,Yt,new Promise((e,t)=>{Ee(this,Ur,e,"f"),Ee(this,er,t,"f")}),"f"),R(this,Dr,"f").catch(()=>{}),R(this,Yt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},R(this,Ea,"f"))},0)}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(n=e.choices[0])==null?void 0:n.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Hi(e)||qi(e))&&e.content)this._emit("functionCallResult",e.content);else if(Lt(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Lt(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}_connected(){this.ended||(R(this,Fr,"f").call(this),this._emit("connect"))}get ended(){return R(this,tr,"f")}get errored(){return R(this,Br,"f")}get aborted(){return R(this,Zr,"f")}abort(){this.controller.abort()}on(e,t){return(R(this,Fe,"f")[e]||(R(this,Fe,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=R(this,Fe,"f")[e];if(!n)return this;const a=n.findIndex(s=>s.listener===t);return a>=0&&n.splice(a,1),this}once(e,t){return(R(this,Fe,"f")[e]||(R(this,Fe,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Ee(this,Tt,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Ee(this,Tt,!0,"f"),await R(this,Yt,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new j("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),R(this,re,"m",va).call(this)}async finalMessage(){return await this.done(),R(this,re,"m",ln).call(this)}async finalFunctionCall(){return await this.done(),R(this,re,"m",wa).call(this)}async finalFunctionCallResult(){return await this.done(),R(this,re,"m",xa).call(this)}async totalUsage(){return await this.done(),R(this,re,"m",Aa).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(R(this,tr,"f"))return;e==="end"&&(Ee(this,tr,!0,"f"),R(this,Ur,"f").call(this));const n=R(this,Fe,"f")[e];if(n&&(R(this,Fe,"f")[e]=n.filter(a=>!a.once),n.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!R(this,Tt,"f")&&!(n!=null&&n.length)&&Promise.reject(a),R(this,Qt,"f").call(this,a),R(this,er,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!R(this,Tt,"f")&&!(n!=null&&n.length)&&Promise.reject(a),R(this,Qt,"f").call(this,a),R(this,er,"f").call(this,a),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=R(this,re,"m",ln).call(this);t&&this._emit("finalMessage",t);const n=R(this,re,"m",va).call(this);n&&this._emit("finalContent",n);const a=R(this,re,"m",wa).call(this);a&&this._emit("finalFunctionCall",a);const s=R(this,re,"m",xa).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",R(this,re,"m",Aa).call(this))}async _createChatCompletion(e,t,n){const a=n==null?void 0:n.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),R(this,re,"m",Wi).call(this,t);const s=await e.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(s)}async _runChatCompletion(e,t,n){for(const a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){var h;const a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:c=Ds}=n||{},l={};for(const m of t.functions)l[m.name||m.function.name]=m;const d=t.functions.map(m=>({name:m.name||m.function.name,parameters:m.parameters,description:m.description}));for(const m of t.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){const v=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},n)).choices[0])==null?void 0:h.message;if(!v)throw new j("missing message in ChatCompletion response");if(!v.function_call)return;const{name:p,arguments:E}=v.function_call,k=l[p];if(k){if(u&&u!==p){const K=`Invalid function_call: ${JSON.stringify(p)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:p,content:K});continue}}else{const K=`Invalid function_call: ${JSON.stringify(p)}. Available options are: ${d.map(z=>JSON.stringify(z.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:p,content:K});continue}let I;try{I=Ms(k)?await k.parse(E):E}catch(K){this._addMessage({role:a,name:p,content:K instanceof Error?K.message:String(K)});continue}const B=await k.function(I,this),Z=R(this,re,"m",Oa).call(this,B);if(this._addMessage({role:a,name:p,content:Z}),u)return}}async _runTools(e,t,n){var h,m;const a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&((h=s==null?void 0:s.function)==null?void 0:h.name),{maxChatCompletions:c=Ds}=n||{},l={};for(const f of t.tools)f.type==="function"&&(l[f.function.name||f.function.function.name]=f.function);const d="tools"in t?t.tools.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){const p=(m=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:d,messages:[...this.messages]},n)).choices[0])==null?void 0:m.message;if(!p)throw new j("missing message in ChatCompletion response");if(!p.tool_calls)return;for(const E of p.tool_calls){if(E.type!=="function")continue;const k=E.id,{name:I,arguments:B}=E.function,Z=l[I];if(Z){if(u&&u!==I){const _=`Invalid tool_call: ${JSON.stringify(I)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:k,content:_});continue}}else{const _=`Invalid tool_call: ${JSON.stringify(I)}. Available options are: ${d.map(x=>JSON.stringify(x.function.name)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:k,content:_});continue}let K;try{K=Ms(Z)?await Z.parse(B):B}catch(_){const x=_ instanceof Error?_.message:String(_);this._addMessage({role:a,tool_call_id:k,content:x});continue}const z=await Z.function(K,this),b=R(this,re,"m",Oa).call(this,z);if(this._addMessage({role:a,tool_call_id:k,content:b}),u)return}}}}Dr=new WeakMap,Fr=new WeakMap,Qt=new WeakMap,Yt=new WeakMap,Ur=new WeakMap,er=new WeakMap,Fe=new WeakMap,tr=new WeakMap,Br=new WeakMap,Zr=new WeakMap,Tt=new WeakMap,Ea=new WeakMap,re=new WeakSet,va=function(){return R(this,re,"m",ln).call(this).content??null},ln=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Lt(t))return{...t,content:t.content??null}}throw new j("stream ended without producing a ChatCompletionMessage with role=assistant")},wa=function(){var e,t;for(let n=this.messages.length-1;n>=0;n--){const a=this.messages[n];if(Lt(a)&&(a!=null&&a.function_call))return a.function_call;if(Lt(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},xa=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Hi(t)&&t.content!=null||qi(t)&&t.content!=null&&this.messages.some(n=>{var a;return n.role==="assistant"&&((a=n.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},Aa=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Wi=function(e){if(e.n!=null&&e.n>1)throw new j("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Oa=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class _r extends Ki{static runFunctions(e,t,n){const a=new _r,s={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,n){const a=new _r,s={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e){super._addMessage(e),Lt(e)&&e.content&&this._emit("content",e.content)}}var Oe=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Jn=function(r,e,t,n,a){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!a:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?a.call(r,t):a?a.value=t:e.set(r,t),t},Ce,Ge,Gn,Xn,Cr,Fs;class vr extends Ki{constructor(){super(...arguments),Ce.add(this),Ge.set(this,void 0)}get currentChatCompletionSnapshot(){return Oe(this,Ge,"f")}static fromReadableStream(e){const t=new vr;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const a=new vr;return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,n){var i;const a=n==null?void 0:n.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Oe(this,Ce,"m",Gn).call(this);const s=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const o of s)Oe(this,Ce,"m",Xn).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new ct;return this._addChatCompletion(Oe(this,Ce,"m",Cr).call(this))}async _fromReadableStream(e,t){var i;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Oe(this,Ce,"m",Gn).call(this),this._connected();const a=tt.fromReadableStream(e,this.controller);let s;for await(const o of a)s&&s!==o.id&&this._addChatCompletion(Oe(this,Ce,"m",Cr).call(this)),Oe(this,Ce,"m",Xn).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new ct;return this._addChatCompletion(Oe(this,Ce,"m",Cr).call(this))}[(Ge=new WeakMap,Ce=new WeakSet,Gn=function(){this.ended||Jn(this,Ge,void 0,"f")},Xn=function(t){var i,o,u;if(this.ended)return;const n=Oe(this,Ce,"m",Fs).call(this,t);this._emit("chunk",t,n);const a=(o=(i=t.choices[0])==null?void 0:i.delta)==null?void 0:o.content,s=(u=n.choices[0])==null?void 0:u.message;a!=null&&(s==null?void 0:s.role)==="assistant"&&(s!=null&&s.content)&&this._emit("content",a,s.content)},Cr=function(){if(this.ended)throw new j("stream has ended, this shouldn't happen");const t=Oe(this,Ge,"f");if(!t)throw new j("request ended without sending any chunks");return Jn(this,Ge,void 0,"f"),ll(t)},Fs=function(t){var n,a,s;let i=Oe(this,Ge,"f");const{choices:o,...u}=t;i?Object.assign(i,u):i=Jn(this,Ge,{...u,choices:[]},"f");for(const{delta:c,finish_reason:l,index:d,logprobs:h=null,...m}of t.choices){let f=i.choices[d];if(f||(f=i.choices[d]={finish_reason:l,index:d,message:{},logprobs:h,...m}),h)if(!f.logprobs)f.logprobs=Object.assign({},h);else{const{content:B,...Z}=h;Object.assign(f.logprobs,Z),B&&((n=f.logprobs).content??(n.content=[]),f.logprobs.content.push(...B))}if(l&&(f.finish_reason=l),Object.assign(f,m),!c)continue;const{content:v,function_call:p,role:E,tool_calls:k,...I}=c;if(Object.assign(f.message,I),v&&(f.message.content=(f.message.content||"")+v),E&&(f.message.role=E),p&&(f.message.function_call?(p.name&&(f.message.function_call.name=p.name),p.arguments&&((a=f.message.function_call).arguments??(a.arguments=""),f.message.function_call.arguments+=p.arguments)):f.message.function_call=p),k){f.message.tool_calls||(f.message.tool_calls=[]);for(const{index:B,id:Z,type:K,function:z,...b}of k){const _=(s=f.message.tool_calls)[B]??(s[B]={});Object.assign(_,b),Z&&(_.id=Z),K&&(_.type=K),z&&(_.function??(_.function={arguments:""})),z!=null&&z.name&&(_.function.name=z.name),z!=null&&z.arguments&&(_.function.arguments+=z.arguments)}}}return i},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",a=>{const s=t.shift();s?s(a):e.push(a)}),this.on("end",()=>{n=!0;for(const a of t)a(void 0);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(s=>t.push(s)).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0})}}toReadableStream(){return new tt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function ll(r){const{id:e,choices:t,created:n,model:a,system_fingerprint:s,...i}=r;return{...i,id:e,choices:t.map(({message:o,finish_reason:u,index:c,logprobs:l,...d})=>{if(!u)throw new j(`missing finish_reason for choice ${c}`);const{content:h=null,function_call:m,tool_calls:f,...v}=o,p=o.role;if(!p)throw new j(`missing role for choice ${c}`);if(m){const{arguments:E,name:k}=m;if(E==null)throw new j(`missing function_call.arguments for choice ${c}`);if(!k)throw new j(`missing function_call.name for choice ${c}`);return{...d,message:{content:h,function_call:{arguments:E,name:k},role:p},finish_reason:u,index:c,logprobs:l}}return f?{...d,index:c,finish_reason:u,logprobs:l,message:{...v,role:p,content:h,tool_calls:f.map((E,k)=>{const{function:I,type:B,id:Z,...K}=E,{arguments:z,name:b,..._}=I||{};if(Z==null)throw new j(`missing choices[${c}].tool_calls[${k}].id
${Ir(r)}`);if(B==null)throw new j(`missing choices[${c}].tool_calls[${k}].type
${Ir(r)}`);if(b==null)throw new j(`missing choices[${c}].tool_calls[${k}].function.name
${Ir(r)}`);if(z==null)throw new j(`missing choices[${c}].tool_calls[${k}].function.arguments
${Ir(r)}`);return{...K,id:Z,type:B,function:{..._,name:b,arguments:z}}})}}:{...d,message:{...v,content:h,role:p},finish_reason:u,index:c,logprobs:l}}),created:n,model:a,object:"chat.completion",...s?{system_fingerprint:s}:{}}}function Ir(r){return JSON.stringify(r)}class Mt extends vr{static fromReadableStream(e){const t=new Mt;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const a=new Mt,s={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,n){const a=new Mt,s={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}}let Ji=class extends V{runFunctions(e,t){return e.stream?Mt.runFunctions(this._client.chat.completions,e,t):_r.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Mt.runTools(this._client.chat.completions,e,t):_r.runTools(this._client.chat.completions,e,t)}stream(e,t){return vr.createChatCompletion(this._client.chat.completions,e,t)}};class dn extends V{constructor(){super(...arguments),this.completions=new Ji(this._client)}}(function(r){r.Completions=Ji})(dn||(dn={}));let hn=class extends V{retrieve(e,t,n,a){return this._client.get(`/threads/${e}/messages/${t}/files/${n}`,{...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t,n={},a){return Le(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,qa,{query:n,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}};class qa extends We{}(function(r){r.MessageFilesPage=qa})(hn||(hn={}));class fn extends V{constructor(){super(...arguments),this.files=new hn(this._client)}create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}update(e,t,n,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t={},n){return Le(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Wa,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}}class Wa extends We{}(function(r){r.ThreadMessagesPage=Wa,r.Files=hn,r.MessageFilesPage=qa})(fn||(fn={}));class mn extends V{retrieve(e,t,n,a){return this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t,n={},a){return Le(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Ka,{query:n,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}}class Ka extends We{}(function(r){r.RunStepsPage=Ka})(mn||(mn={}));class pn extends V{constructor(){super(...arguments),this.steps=new mn(this._client)}create(e,t,n){return this._client.post(`/threads/${e}/runs`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}update(e,t,n,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t={},n){return Le(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Ja,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}submitToolOutputs(e,t,n,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}}class Ja extends We{}(function(r){r.RunsPage=Ja,r.Steps=mn,r.RunStepsPage=Ka})(pn||(pn={}));class gn extends V{constructor(){super(...arguments),this.runs=new pn(this._client),this.messages=new fn(this._client)}create(e={},t){return Le(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v1",...n==null?void 0:n.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}(function(r){r.Runs=pn,r.RunsPage=Ja,r.Messages=fn,r.ThreadMessagesPage=Wa})(gn||(gn={}));class yn extends V{constructor(){super(...arguments),this.chat=new dn(this._client),this.assistants=new cn(this._client),this.threads=new gn(this._client)}}(function(r){r.Chat=dn,r.Assistants=cn,r.AssistantsPage=Ha,r.Threads=gn})(yn||(yn={}));class bn extends V{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}bn||(bn={});class _n extends V{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}_n||(_n={});class vn extends V{create(e,t){return this._client.post("/files",br({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Le(e)?this.list({},e):this._client.getAPIList("/files",Ga,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){const a=new Set(["processed","error","deleted"]),s=Date.now();let i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await Zi(t),i=await this.retrieve(e),Date.now()-s>n)throw new $n({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return i}}class Ga extends Va{}(function(r){r.FileObjectsPage=Ga})(vn||(vn={}));class wn extends V{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Le(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Xa,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return Le(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Qa,{query:t,...n})}}class Xa extends We{}class Qa extends We{}(function(r){r.FineTuningJobsPage=Xa,r.FineTuningJobEventsPage=Qa})(wn||(wn={}));class xn extends V{constructor(){super(...arguments),this.jobs=new wn(this._client)}}(function(r){r.Jobs=wn,r.FineTuningJobsPage=Xa,r.FineTuningJobEventsPage=Qa})(xn||(xn={}));class An extends V{createVariation(e,t){return this._client.post("/images/variations",br({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",br({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}An||(An={});class En extends V{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ya,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Ya extends Va{}(function(r){r.ModelsPage=Ya})(En||(En={}));class On extends V{create(e,t){return this._client.post("/moderations",{body:e,...t})}}On||(On={});var Gi;let G=class extends Qc{constructor({baseURL:e=Kn("OPENAI_BASE_URL"),apiKey:t=Kn("OPENAI_API_KEY"),organization:n=Kn("OPENAI_ORG_ID")??null,...a}={}){if(t===void 0)throw new j("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:n,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&cl())throw new j(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new bn(this),this.chat=new rn(this),this.embeddings=new _n(this),this.files=new vn(this),this.images=new An(this),this.audio=new on(this),this.moderations=new On(this),this.models=new En(this),this.fineTuning=new xn(this),this.beta=new yn(this),this._options=s,this.apiKey=t,this.organization=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};Gi=G;G.OpenAI=Gi;G.OpenAIError=j;G.APIError=me;G.APIConnectionError=Or;G.APIConnectionTimeoutError=$n;G.APIUserAbortError=ct;G.NotFoundError=Da;G.ConflictError=Fa;G.RateLimitError=Ba;G.BadRequestError=$a;G.AuthenticationError=La;G.InternalServerError=Za;G.PermissionDeniedError=Ma;G.UnprocessableEntityError=Ua;const{OpenAIError:Sf,APIError:Cf,APIConnectionError:If,APIConnectionTimeoutError:dl,APIUserAbortError:hl,NotFoundError:Rf,ConflictError:Nf,RateLimitError:jf,BadRequestError:$f,AuthenticationError:Lf,InternalServerError:Mf,PermissionDeniedError:Df,UnprocessableEntityError:Ff}=Uc;(function(r){r.toFile=Fi,r.fileFromPath=$i,r.Page=Va,r.CursorPage=We,r.Completions=bn,r.Chat=rn,r.Embeddings=_n,r.Files=vn,r.FileObjectsPage=Ga,r.Images=An,r.Audio=on,r.Moderations=On,r.Models=En,r.ModelsPage=Ya,r.FineTuning=xn,r.Beta=yn})(G||(G={}));const Us="__run";class es{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new es({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class ts extends es{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new ts({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}var Qn={};const fl=()=>typeof window<"u"&&typeof window.document<"u",ml=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",pl=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Xi=()=>typeof Deno<"u",gl=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Xi(),yl=()=>{let r;return fl()?r="browser":gl()?r="node":ml()?r="webworker":pl()?r="jsdom":Xi()?r="deno":r="other",r};let Yn;async function bl(){return Yn===void 0&&(Yn={library:"langchain-js",runtime:yl()}),Yn}function we(r){try{return typeof process<"u"?Qn==null?void 0:Qn[r]:void 0}catch{return}}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var _l=typeof window=="object"?window:{},S="0123456789abcdef".split(""),vl=[-2147483648,8388608,32768,128],Pe=[24,16,8,0],J=[];function Se(r){r?(J[0]=J[16]=J[1]=J[2]=J[3]=J[4]=J[5]=J[6]=J[7]=J[8]=J[9]=J[10]=J[11]=J[12]=J[13]=J[14]=J[15]=0,this.blocks=J):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Se.prototype.update=function(r){if(!this.finalized){var e=typeof r!="string";e&&r.constructor===_l.ArrayBuffer&&(r=new Uint8Array(r));for(var t,n=0,a,s=r.length||0,i=this.blocks;n<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;n<s&&a<64;++n)i[a>>2]|=r[n]<<Pe[a++&3];else for(a=this.start;n<s&&a<64;++n)t=r.charCodeAt(n),t<128?i[a>>2]|=t<<Pe[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<Pe[a++&3],i[a>>2]|=(128|t&63)<<Pe[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<Pe[a++&3],i[a>>2]|=(128|t>>6&63)<<Pe[a++&3],i[a>>2]|=(128|t&63)<<Pe[a++&3]):(t=65536+((t&1023)<<10|r.charCodeAt(++n)&1023),i[a>>2]|=(240|t>>18)<<Pe[a++&3],i[a>>2]|=(128|t>>12&63)<<Pe[a++&3],i[a>>2]|=(128|t>>6&63)<<Pe[a++&3],i[a>>2]|=(128|t&63)<<Pe[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Se.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>2]|=vl[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};Se.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&n,o=r<<5|r>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=r&e|~r&t,o=a<<5|a>>>27,n=o+s+n+1518500249+u[i+1]<<0,r=r<<30|r>>>2,s=a&r|~a&e,o=n<<5|n>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=n&a|~n&r,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,n=n<<30|n>>>2,s=t&n|~t&a,o=e<<5|e>>>27,r=o+s+r+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^n,o=r<<5|r>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=r^e^t,o=a<<5|a>>>27,n=o+s+n+1859775393+u[i+1]<<0,r=r<<30|r>>>2,s=a^r^e,o=n<<5|n>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=n^a^r,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,n=n<<30|n>>>2,s=t^n^a,o=e<<5|e>>>27,r=o+s+r+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&n|t&n,o=r<<5|r>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=r&e|r&t|e&t,o=a<<5|a>>>27,n=o+s+n-1894007588+u[i+1]<<0,r=r<<30|r>>>2,s=a&r|a&e|r&e,o=n<<5|n>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=n&a|n&r|a&r,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,n=n<<30|n>>>2,s=t&n|t&a|n&a,o=e<<5|e>>>27,r=o+s+r-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^n,o=r<<5|r>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=r^e^t,o=a<<5|a>>>27,n=o+s+n-899497514+u[i+1]<<0,r=r<<30|r>>>2,s=a^r^e,o=n<<5|n>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=n^a^r,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,n=n<<30|n>>>2,s=t^n^a,o=e<<5|e>>>27,r=o+s+r-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+a<<0};Se.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,a=this.h4;return S[r>>28&15]+S[r>>24&15]+S[r>>20&15]+S[r>>16&15]+S[r>>12&15]+S[r>>8&15]+S[r>>4&15]+S[r&15]+S[e>>28&15]+S[e>>24&15]+S[e>>20&15]+S[e>>16&15]+S[e>>12&15]+S[e>>8&15]+S[e>>4&15]+S[e&15]+S[t>>28&15]+S[t>>24&15]+S[t>>20&15]+S[t>>16&15]+S[t>>12&15]+S[t>>8&15]+S[t>>4&15]+S[t&15]+S[n>>28&15]+S[n>>24&15]+S[n>>20&15]+S[n>>16&15]+S[n>>12&15]+S[n>>8&15]+S[n>>4&15]+S[n&15]+S[a>>28&15]+S[a>>24&15]+S[a>>20&15]+S[a>>16&15]+S[a>>12&15]+S[a>>8&15]+S[a>>4&15]+S[a&15]};Se.prototype.toString=Se.prototype.hex;Se.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,a=this.h4;return[r>>24&255,r>>16&255,r>>8&255,r&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,a>>24&255,a>>16&255,a>>8&255,a&255]};Se.prototype.array=Se.prototype.digest;Se.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(20),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),r};const wl=r=>new Se(!0).update(r).hex(),Bs=(...r)=>wl(r.join("_"));class xl{}const Al=new Map;class rs extends xl{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Bs(e,t))??null)}async update(e,t,n){this.cache.set(Bs(e,t),n)}static global(){return new rs(Al)}}class Qi extends xt{}class El extends Qi{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new hr(this.value)]}}class Ol extends Qi{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Si(this.messages)}toChatMessages(){return this.messages}}var Mn={exports:{}},Yi={};function Ae(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Pl=Ae;Ae.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Ae.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Ae.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Ae.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Ae.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Ae.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Ae.prototype.start=Ae.prototype.try;Ae.prototype.errors=function(){return this._errors};Ae.prototype.attempts=function(){return this._attempts};Ae.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var a=this._errors[n],s=a.message,i=(r[s]||0)+1;r[s]=i,i>=t&&(e=a,t=i)}return e};(function(r){var e=Pl;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)n[a]=t[a];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],i=0;i<n.retries;i++)s.push(this.createTimeout(i,n));return t&&t.forever&&!s.length&&s.push(this.createTimeout(i,n)),s.sort(function(o,u){return o-u}),s},r.createTimeout=function(t,n){var a=n.randomize?Math.random()+1:1,s=Math.round(a*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return s=Math.min(s,n.maxTimeout),s},r.wrap=function(t,n,a){if(n instanceof Array&&(a=n,n=null),!a){a=[];for(var s in t)typeof t[s]=="function"&&a.push(s)}for(var i=0;i<a.length;i++){var o=a[i],u=t[o];t[o]=(function(l){var d=r.operation(n),h=Array.prototype.slice.call(arguments,1),m=h.pop();h.push(function(f){d.retry(f)||(f&&(arguments[0]=d.mainError()),m.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}).bind(t,u),t[o].options=n}}})(Yi);var kl=Yi;const Tl=kl,Sl=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class eo extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Cl=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},Il=r=>Sl.includes(r),to=(r,e)=>new Promise((t,n)=>{e={onFailedAttempt:()=>{},retries:10,...e};const a=Tl.operation(e);a.attempt(async s=>{try{t(await r(s))}catch(i){if(!(i instanceof Error)){n(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof eo)a.stop(),n(i.originalError);else if(i instanceof TypeError&&!Il(i.message))a.stop(),n(i);else{Cl(i,s,e);try{await e.onFailedAttempt(i)}catch(o){n(o);return}a.retry(i)||n(a.mainError())}}})});Mn.exports=to;Mn.exports.default=to;Mn.exports.AbortError=eo;var Rl=Mn.exports;const Pn=Ra(Rl);var ro={},no={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function a(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function s(u,c,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var m=new a(l,d||u,h),f=t?t+c:c;return u._events[f]?u._events[f].fn?u._events[f]=[u._events[f],m]:u._events[f].push(m):(u._events[f]=m,u._eventsCount++),u}function i(u,c){--u._eventsCount===0?u._events=new n:delete u._events[c]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,d;if(this._eventsCount===0)return c;for(d in l=this._events)e.call(l,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=t?t+c:c,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,m=d.length,f=new Array(m);h<m;h++)f[h]=d[h].fn;return f},o.prototype.listenerCount=function(c){var l=t?t+c:c,d=this._events[l];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,l,d,h,m,f){var v=t?t+c:c;if(!this._events[v])return!1;var p=this._events[v],E=arguments.length,k,I;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),E){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,l),!0;case 3:return p.fn.call(p.context,l,d),!0;case 4:return p.fn.call(p.context,l,d,h),!0;case 5:return p.fn.call(p.context,l,d,h,m),!0;case 6:return p.fn.call(p.context,l,d,h,m,f),!0}for(I=1,k=new Array(E-1);I<E;I++)k[I-1]=arguments[I];p.fn.apply(p.context,k)}else{var B=p.length,Z;for(I=0;I<B;I++)switch(p[I].once&&this.removeListener(c,p[I].fn,void 0,!0),E){case 1:p[I].fn.call(p[I].context);break;case 2:p[I].fn.call(p[I].context,l);break;case 3:p[I].fn.call(p[I].context,l,d);break;case 4:p[I].fn.call(p[I].context,l,d,h);break;default:if(!k)for(Z=1,k=new Array(E-1);Z<E;Z++)k[Z-1]=arguments[Z];p[I].fn.apply(p[I].context,k)}}return!0},o.prototype.on=function(c,l,d){return s(this,c,l,d,!1)},o.prototype.once=function(c,l,d){return s(this,c,l,d,!0)},o.prototype.removeListener=function(c,l,d,h){var m=t?t+c:c;if(!this._events[m])return this;if(!l)return i(this,m),this;var f=this._events[m];if(f.fn)f.fn===l&&(!h||f.once)&&(!d||f.context===d)&&i(this,m);else{for(var v=0,p=[],E=f.length;v<E;v++)(f[v].fn!==l||h&&!f[v].once||d&&f[v].context!==d)&&p.push(f[v]);p.length?this._events[m]=p.length===1?p[0]:p:i(this,m)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=t?t+c:c,this._events[l]&&i(this,l)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,r.exports=o})(no);var Nl=no.exports,Dn={exports:{}},jl=(r,e)=>(e=e||(()=>{}),r.then(t=>new Promise(n=>{n(e())}).then(()=>t),t=>new Promise(n=>{n(e())}).then(()=>{throw t})));const $l=jl;class ao extends Error{constructor(e){super(e),this.name="TimeoutError"}}const so=(r,e,t)=>new Promise((n,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){n(r);return}const s=setTimeout(()=>{if(typeof t=="function"){try{n(t())}catch(u){a(u)}return}const i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new ao(i);typeof r.cancel=="function"&&r.cancel(),a(o)},e);$l(r.then(n,a),()=>{clearTimeout(s)})});Dn.exports=so;Dn.exports.default=so;Dn.exports.TimeoutError=ao;var Ll=Dn.exports,ns={},as={};Object.defineProperty(as,"__esModule",{value:!0});function Ml(r,e,t){let n=0,a=r.length;for(;a>0;){const s=a/2|0;let i=n+s;t(r[i],e)<=0?(n=++i,a-=s+1):a=s}return n}as.default=Ml;Object.defineProperty(ns,"__esModule",{value:!0});const Dl=as;class Fl{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const n={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(n);return}const a=Dl.default(this._queue,n,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,n)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}ns.default=Fl;Object.defineProperty(ro,"__esModule",{value:!0});const Ul=Nl,io=Ll,Bl=ns,Rr=()=>{},Zl=new io.TimeoutError;class Vl extends Ul{constructor(e){var t,n,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Rr,this._resolveIdle=Rr,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Bl.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Rr,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Rr,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,a)=>{const s=async()=>{this._pendingCount++,this._intervalCount++;try{const i=this._timeout===void 0&&t.timeout===void 0?e():io.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(Zl)});n(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Be=ro.default=Vl;const zl=[400,401,402,403,404,405,406,407,408,409],Hl=r=>{var t,n;if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.name==="TimeoutError"||r.message.startsWith("AbortError")||r.name==="AbortError"||(r==null?void 0:r.code)==="ECONNABORTED")throw r;const e=((t=r==null?void 0:r.response)==null?void 0:t.status)??(r==null?void 0:r.status);if(e&&zl.includes(+e))throw r;if(((n=r==null?void 0:r.error)==null?void 0:n.code)==="insufficient_quota"){const a=new Error(r==null?void 0:r.message);throw a.name="InsufficientQuotaError",a}};let ss=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Hl;const t="default"in Be?Be.default:Be;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Pn(()=>e(...t).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Fn={};Fn.byteLength=Kl;Fn.toByteArray=Gl;Fn.fromByteArray=Yl;var Re=[],ve=[],ql=typeof Uint8Array<"u"?Uint8Array:Array,ea="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ot=0,Wl=ea.length;Ot<Wl;++Ot)Re[Ot]=ea[Ot],ve[ea.charCodeAt(Ot)]=Ot;ve[45]=62;ve[95]=63;function oo(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function Kl(r){var e=oo(r),t=e[0],n=e[1];return(t+n)*3/4-n}function Jl(r,e,t){return(e+t)*3/4-t}function Gl(r){var e,t=oo(r),n=t[0],a=t[1],s=new ql(Jl(r,n,a)),i=0,o=a>0?n-4:n,u;for(u=0;u<o;u+=4)e=ve[r.charCodeAt(u)]<<18|ve[r.charCodeAt(u+1)]<<12|ve[r.charCodeAt(u+2)]<<6|ve[r.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=ve[r.charCodeAt(u)]<<2|ve[r.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=ve[r.charCodeAt(u)]<<10|ve[r.charCodeAt(u+1)]<<4|ve[r.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function Xl(r){return Re[r>>18&63]+Re[r>>12&63]+Re[r>>6&63]+Re[r&63]}function Ql(r,e,t){for(var n,a=[],s=e;s<t;s+=3)n=(r[s]<<16&16711680)+(r[s+1]<<8&65280)+(r[s+2]&255),a.push(Xl(n));return a.join("")}function Yl(r){for(var e,t=r.length,n=t%3,a=[],s=16383,i=0,o=t-n;i<o;i+=s)a.push(Ql(r,i,i+s>o?o:i+s));return n===1?(e=r[t-1],a.push(Re[e>>2]+Re[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],a.push(Re[e>>10]+Re[e>>4&63]+Re[e<<2&63]+"=")),a.join("")}var ed=Object.defineProperty,td=(r,e,t)=>e in r?ed(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,rd=(r,e,t)=>(td(r,typeof e!="symbol"?e+"":e,t),t);function nd(r,e){let t=Array.from({length:r.length},(n,a)=>({start:a,end:a+1}));for(;t.length>1;){let n=null;for(let a=0;a<t.length-1;a++){const s=r.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(n==null||i<n[0])&&(n=[i,a])}if(n!=null){const a=n[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function ad(r,e){return r.length===1?[e.get(r.join(","))]:nd(r,e).map(t=>e.get(r.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function sd(r){return r.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Pa=class{constructor(r,e){Je(this,"specialTokens");Je(this,"inverseSpecialTokens");Je(this,"patStr");Je(this,"textEncoder",new TextEncoder);Je(this,"textDecoder",new TextDecoder("utf-8"));Je(this,"rankMap",new Map);Je(this,"textMap",new Map);this.patStr=r.pat_str;const t=r.bpe_ranks.split(`
`).filter(Boolean).reduce((n,a)=>{const[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>n[c]=u+l),n},{});for(const[n,a]of Object.entries(t)){const s=Fn.toByteArray(n);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...r.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[a,s])=>(n[s]=this.textEncoder.encode(a),n),{})}encode(r,e=[],t="all"){const n=new RegExp(this.patStr,"ug"),a=Pa.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!i.has(c)):t);if(o.size>0){const c=Pa.specialTokenRegex([...o]),l=r.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;a.lastIndex=l,c=a.exec(r),!(c==null||i.has(c[0]));)l=c.index+1;const d=(c==null?void 0:c.index)??r.length;for(const m of r.substring(u,d).matchAll(n)){const f=this.textEncoder.encode(m[0]),v=this.rankMap.get(f.join(","));if(v!=null){s.push(v);continue}s.push(...ad(f,this.rankMap))}if(c==null)break;let h=this.specialTokens[c[0]];s.push(h),u=c.index+c[0].length}return s}decode(r){const e=[];let t=0;for(let s=0;s<r.length;++s){const i=r[s],o=this.textMap.get(i)??this.inverseSpecialTokens[i];o!=null&&(e.push(o),t+=o.length)}const n=new Uint8Array(t);let a=0;for(const s of e)n.set(s,a),a+=s.length;return this.textDecoder.decode(n)}},uo=Pa;rd(uo,"specialTokenRegex",r=>new RegExp(r.map(e=>sd(e)).join("|"),"g"));function id(r){switch(r){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}const Nr={},od=new ss({});async function ud(r){return r in Nr||(Nr[r]=od.fetch(`https://tiktoken.pages.dev/js/${r}.json`).then(e=>e.json()).then(e=>new uo(e)).catch(e=>{throw delete Nr[r],e})),await Nr[r]}async function cd(r){return ud(id(r))}let jr;const ld=new Uint8Array(16);function dd(){if(!jr&&(jr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!jr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return jr(ld)}const hd=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function fd(r){return typeof r=="string"&&hd.test(r)}const Y=[];for(let r=0;r<256;++r)Y.push((r+256).toString(16).slice(1));function md(r,e=0){return Y[r[e+0]]+Y[r[e+1]]+Y[r[e+2]]+Y[r[e+3]]+"-"+Y[r[e+4]]+Y[r[e+5]]+"-"+Y[r[e+6]]+Y[r[e+7]]+"-"+Y[r[e+8]]+Y[r[e+9]]+"-"+Y[r[e+10]]+Y[r[e+11]]+Y[r[e+12]]+Y[r[e+13]]+Y[r[e+14]]+Y[r[e+15]]}const pd=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Zs={randomUUID:pd};function Ue(r,e,t){if(Zs.randomUUID&&!e&&!r)return Zs.randomUUID();r=r||{};const n=r.random||(r.rng||dd)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(let a=0;a<16;++a)e[t+a]=n[a];return e}return md(n)}var ta={};class gd{}class Pr extends gd{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ki(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof process<"u"?(ta==null?void 0:ta.LANGCHAIN_CALLBACKS_BACKGROUND)!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return xt.prototype.toJSON.call(this)}toJSONNotImplemented(){return xt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Pr{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ue()}),Object.assign(this,e)}}return new t}}var is={exports:{}};is.exports;(function(r){const t=(s=0)=>i=>`\x1B[${38+s};5;${i}m`,n=(s=0)=>(i,o,u)=>`\x1B[${38+s};2;${i};${o};${u}m`;function a(){const s=new Map,i={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};i.color.gray=i.color.blackBright,i.bgColor.bgGray=i.bgColor.bgBlackBright,i.color.grey=i.color.blackBright,i.bgColor.bgGrey=i.bgColor.bgBlackBright;for(const[o,u]of Object.entries(i)){for(const[c,l]of Object.entries(u))i[c]={open:`\x1B[${l[0]}m`,close:`\x1B[${l[1]}m`},u[c]=i[c],s.set(l[0],l[1]);Object.defineProperty(i,o,{value:u,enumerable:!1})}return Object.defineProperty(i,"codes",{value:s,enumerable:!1}),i.color.close="\x1B[39m",i.bgColor.close="\x1B[49m",i.color.ansi256=t(),i.color.ansi16m=n(),i.bgColor.ansi256=t(10),i.bgColor.ansi16m=n(10),Object.defineProperties(i,{rgbToAnsi256:{value:(o,u,c)=>o===u&&u===c?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(c/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:c}=u.groups;c.length===3&&(c=c.split("").map(d=>d+d).join(""));const l=Number.parseInt(c,16);return[l>>16&255,l>>8&255,l&255]},enumerable:!1},hexToAnsi256:{value:o=>i.rgbToAnsi256(...i.hexToRgb(o)),enumerable:!1}}),i}Object.defineProperty(r,"exports",{enumerable:!0,get:a})})(is);var yd=is.exports;const co=Ra(yd);function ra(r,e){return r&&!Array.isArray(r)&&typeof r=="object"?r:{[e]:r}}function bd(r){return r.replace(/[-:.]/g,"")}function _d(r,e){return bd(`${new Date(r).toISOString().slice(0,-1)}000Z`)+e}class Un extends Pr{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var a;const t=_d(e.start_time,e.id),n={...e};if(n.parent_run_id!==void 0){const s=this.runMap.get(n.parent_run_id);s&&(this._addChildRun(s,n),s.child_execution_order=Math.max(s.child_execution_order,n.child_execution_order),n.trace_id=s.trace_id,s.dotted_order!==void 0&&(n.dotted_order=[s.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await((a=this.onRunCreate)==null?void 0:a.call(this,n))}async _endTrace(e){var n;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((n=this.onRunUpdate)==null?void 0:n.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,a,s,i,o,u){var m;const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:n,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((m=this.onLLMStart)==null?void 0:m.call(this,h)),h}async handleChatModelStart(e,t,n,a,s,i,o,u){var m;const c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:n,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(h),await((m=this.onLLMStart)==null?void 0:m.call(this,h)),h}async handleLLMEnd(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((a=this.onLLMEnd)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleLLMError(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=e.message,n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((a=this.onLLMError)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleChainStart(e,t,n,a,s,i,o,u){var h;const c=this._getExecutionOrder(a),l=Date.now(),d={id:n,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,n,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=ra(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=ra(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,n,a,s){var o;const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=e.message+(e!=null&&e.stack?`

${e.stack}`:""),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=ra(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleToolStart(e,t,n,a,s,i,o){var d;const u=this._getExecutionOrder(a),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onToolStart)==null?void 0:d.call(this,l)),l}async handleToolEnd(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleToolError(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=e.message,n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleAgentAction(e,t){var s;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="chain")return;const a=n;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,n))}async handleAgentEnd(e,t){var a;const n=this.runMap.get(t);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,n)))}async handleRetrieverStart(e,t,n,a,s,i,o){var d;const u=this._getExecutionOrder(a),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onRetrieverStart)==null?void 0:d.call(this,l)),l}async handleRetrieverEnd(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleRetrieverError(e,t){var a;const n=this.runMap.get(t);if(!n||(n==null?void 0:n.run_type)!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=e.message,n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,n)),await this._endTrace(n),n}async handleText(e,t){var a;const n=this.runMap.get(t);!n||(n==null?void 0:n.run_type)!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,n)))}async handleLLMNewToken(e,t,n,a,s,i){var u;const o=this.runMap.get(n);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e)),o}}function se(r,e){return`${r.open}${e}${r.close}`}function ke(r,e){try{return JSON.stringify(r,null,2)}catch{return e}}function Xe(r){if(!r.end_time)return"";const e=r.end_time-r.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:oe}=co;class Vs extends Un{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const a=this.runMap.get(n.parent_run_id);if(a)t.push(a),n=a;else break}return t}getBreadcrumbs(e){const n=[...this.getParents(e).reverse(),e].map((a,s,i)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?se(co.bold,o):o}).join(" > ");return se(oe.grey,n)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.green,"[chain/start]")} [${t}] Entering Chain run with input: ${ke(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.cyan,"[chain/end]")} [${t}] [${Xe(e)}] Exiting Chain run with output: ${ke(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.red,"[chain/error]")} [${t}] [${Xe(e)}] Chain run errored with error: ${ke(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${se(oe.green,"[llm/start]")} [${t}] Entering LLM run with input: ${ke(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.cyan,"[llm/end]")} [${t}] [${Xe(e)}] Exiting LLM run with output: ${ke(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.red,"[llm/error]")} [${t}] [${Xe(e)}] LLM run errored with error: ${ke(e.error,"[error]")}`)}onToolStart(e){var n;const t=this.getBreadcrumbs(e);console.log(`${se(oe.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(n=e.inputs.input)==null?void 0:n.trim()}"`)}onToolEnd(e){var n,a;const t=this.getBreadcrumbs(e);console.log(`${se(oe.cyan,"[tool/end]")} [${t}] [${Xe(e)}] Exiting Tool run with output: "${(a=(n=e.outputs)==null?void 0:n.output)==null?void 0:a.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.red,"[tool/error]")} [${t}] [${Xe(e)}] Tool run errored with error: ${ke(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${ke(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.cyan,"[retriever/end]")} [${t}] [${Xe(e)}] Exiting Retriever run with output: ${ke(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${se(oe.red,"[retriever/error]")} [${t}] [${Xe(e)}] Retriever run errored with error: ${ke(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${se(oe.blue,"[agent/action]")} [${n}] Agent selected action: ${ke(t.actions[t.actions.length-1],"[action]")}`)}}const vd=[400,401,403,404,405,406,407,408],wd=[409];class xd{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t="default"in Be?Be.default:Be;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Pn(()=>e(...t).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt(n){var s;if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.message.startsWith("AbortError")||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const a=(s=n==null?void 0:n.response)==null?void 0:s.status;if(a){if(vd.includes(+a))throw n;if(wd.includes(+a))return}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}function zs(r){return typeof(r==null?void 0:r._getType)=="function"}function Hs(r){const e={type:r._getType(),data:{content:r.content}};return r!=null&&r.additional_kwargs&&Object.keys(r.additional_kwargs).length>0&&(e.data.additional_kwargs={...r.additional_kwargs}),e}var sr={};let Me;const Ad=()=>typeof window<"u"&&typeof window.document<"u",Ed=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Od=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),lo=()=>typeof Deno<"u",Pd=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!lo(),kd=()=>Me||(Ad()?Me="browser":Pd()?Me="node":Ed()?Me="webworker":Od()?Me="jsdom":lo()?Me="deno":Me="other",Me);let na;async function Td(){if(na===void 0){const r=kd(),e=Id();na={library:"langsmith",runtime:r,sdk:"langsmith-js",sdk_version:ho,...e}}return na}function Sd(){const r=Cd()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[n,a]of Object.entries(r))n.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[n]=a);return e}function Cd(){try{return typeof process<"u"&&sr?Object.entries(sr).reduce((r,[e,t])=>(r[e]=String(t),r),{}):void 0}catch{return}}function St(r){try{return typeof process<"u"?sr==null?void 0:sr[r]:void 0}catch{return}}let aa;function Id(){if(aa!==void 0)return aa;const r=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of r){const n=St(t);n!==void 0&&(e[t]=n)}return aa=e,e}const qs=r=>{const t=r.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},dt=async(r,e)=>{const t=await r.text();if(!r.ok)throw new Error(`Failed to ${e}: ${r.status} ${r.statusText} ${t}`)};async function Rd(r){const e=[];for await(const t of r)e.push(t);return e}function sa(r){if(r!==void 0)return r.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function q(r){if(!fd(r))throw new Error(`Invalid UUID: ${r}`)}class os{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=os.getDefaultClientConfig();this.apiUrl=sa(e.apiUrl??t.apiUrl)??"",this.apiKey=sa(e.apiKey??t.apiKey),this.webUrl=sa(e.webUrl??t.webUrl),this.validateApiKeyIfHosted(),this.timeout_ms=e.timeout_ms??12e3,this.caller=new xd(e.callerOptions??{}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs}static getDefaultClientConfig(){const e=St("LANGCHAIN_API_KEY"),t=St("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",n=St("LANGCHAIN_HIDE_INPUTS")==="true",a=St("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:a}}validateApiKeyIfHosted(){if(!qs(this.apiUrl)&&!this.apiKey)throw new Error("API key must be provided when using hosted LangSmith API")}getHostUrl(){return this.webUrl?this.webUrl:qs(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${ho}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs?{}:e}processOutputs(e){return this.hideOutputs?{}:e}async _getResponse(e,t){const n=(t==null?void 0:t.toString())??"",a=`${this.apiUrl}${e}?${n}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let n=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(a));const s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const o=await i.json();if(o.length===0||(yield o,o.length<a))break;n+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",a="runs"){const s=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];const u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}async createRun(e){const t={...this.headers,"Content-Type":"application/json"},n=e.extra??{},a=n.metadata,s=await Td(),i=Sd(),o=e.project_name;delete e.project_name;const u={session_name:o,...e,extra:{...e.extra,runtime:{...s,...n.runtime},metadata:{...i,...i.revision_id||e.revision_id?{revision_id:e.revision_id??i.revision_id}:{},...a}}};u.inputs=this.processInputs(u.inputs),u.outputs&&(u.outputs=this.processOutputs(u.outputs)),u.start_time=e.start_time??Date.now();const c=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms)});await dt(c,"create run")}async updateRun(e,t){q(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:n,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await dt(a,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){q(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(t!==void 0){let a;t.session_id?a=t.session_id:n!=null&&n.projectName?a=(await this.readProject({projectName:n==null?void 0:n.projectName})).id:n!=null&&n.projectId?a=n==null?void 0:n.projectId:a=(await this.readProject({projectName:St("LANGCHAIN_PROJECT")||"default"})).id;const s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Rd(this.listRuns({id:e.child_run_ids})),n={},a={};t.sort((s,i)=>((s==null?void 0:s.dotted_order)??"").localeCompare((i==null?void 0:i.dotted_order)??""));for(const s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in n||(n[s.parent_run_id]=[]),n[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=n[e.id]||[];for(const s in n)s!==e.id&&(a[s].child_runs=n[s]);return e}async*listRuns({projectId:e,projectName:t,parentRunId:n,referenceExampleId:a,startTime:s,executionOrder:i,runType:o,error:u,id:c,query:l,filter:d,limit:h}){let m=e;if(t){if(e)throw new Error("Only one of projectId or projectName may be given");m=(await this.readProject({projectName:t})).id}const f={session:m?[m]:null,run_type:o,reference_example:a,query:l,filter:d,execution_order:i,parent_run:n?[n]:null,start_time:s?s.toISOString():null,error:u,id:c,limit:h};for await(const v of this._getCursorPaginatedList("/runs/query",f))yield*v}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||Ue()};q(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){q(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await dt(t,"unshare run")}async readRunSharedLink(e){q(e);const n=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(t!==void 0)for(const i of t)n.append("id",i);return q(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),q(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};q(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms)})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){q(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await dt(t,"unshare dataset")}async readSharedDataset(e){return q(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){const o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};n&&(c.metadata=n);const l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);const d=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),h=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return h}async updateProject(e,{name:t=null,description:n=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=s;a&&(u={...u||{},metadata:a});const c={name:t,extra:u,description:n,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),d=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return d}async readProject({projectId:e,projectName:t}){let n="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)q(e),n+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const s=await this._get(n,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){const o=new URLSearchParams;if(e!==void 0)for(const u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),n!==void 0&&o.append("name_contains",n),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){const u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(const u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let n;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:t})).id:n=e,q(n);const a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await dt(a,`delete session ${n} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:a,description:s,dataType:i,name:o}){const u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);const l=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok){const h=await l.json();throw h.detail&&h.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:n}={}){const a={name:e,description:t};n&&(a.data_type=n);const s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok){const o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)q(e),n+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const s=await this._get(n,a);let i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const n="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:a,datasetNameContains:s}={}){const i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(n!==void 0)for(const u of n)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(const u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)q(a),n+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const s=await this.caller.call(fetch,this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok)throw new Error(`Failed to delete ${n}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:n,datasetName:a,createdAt:s,exampleId:i}){let o=n;if(o===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:a})).id);const u=s||new Date,c={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:i},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){const{inputs:t,outputs:n,sourceRunIds:a,exampleIds:s,datasetId:i,datasetName:o}=e;let u=i;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);const c=t.map((h,m)=>({dataset_id:u,inputs:h,outputs:n?n[m]:void 0,id:s?s[m]:void 0,source_run_id:a?a[m]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const a=e.map(i=>zs(i)?Hs(i):i),s=zs(t)?Hs(t):t;return this.createExample({input:a},{output:s},n)}async readExample(e){q(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n}={}){let a;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)a=e;else if(t!==void 0)a=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const s=new URLSearchParams({dataset:a});if(n!==void 0)for(const i of n)s.append("id",i);for await(const i of this._getPaginated("/examples",s))yield*i}async deleteExample(e){q(e);const t=`/examples/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async updateExample(e,t){q(e);const n=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to update example ${e}: ${n.status} ${n.statusText}`);return await n.json()}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s);let u=n??{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});const c=o.targetRunId??i.id;return await this.createFeedback(c,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:n,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,eager:d=!1}){var p;const h={type:u??"api",metadata:o??{}};c!==void 0&&(h==null?void 0:h.metadata)!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:c}),(h==null?void 0:h.metadata)!==void 0&&((p=h.metadata.__run)==null?void 0:p.run_id)!==void 0&&q(h.metadata.__run.run_id);const m={id:l??Ue(),run_id:e,key:t,score:n,value:a,correction:s,comment:i,feedback_source:h},f=`${this.apiUrl}/feedback`+(d?"/eager":""),v=await this.caller.call(fetch,f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms)});return await dt(v,"create feedback"),m}async updateFeedback(e,{score:t,value:n,correction:a,comment:s}){const i={};t!=null&&(i.score=t),n!=null&&(i.value=n),a!=null&&(i.correction=a),s!=null&&(i.comment=s),q(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});await dt(o,"update feedback")}async readFeedback(e){q(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){q(e);const t=`/feedback/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const s of t)a.append("key",s);if(n)for(const s of n)a.append("source",s);for await(const s of this._getPaginated("/feedback",a))yield*s}}const ho="0.0.66";class Nd extends Un{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:a}=e;this.projectName=n??we("LANGCHAIN_PROJECT")??we("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new os({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await bl()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs};await this.client.updateRun(e.id,t)}async onRetrieverStart(e){await this._persistRunSingle(e)}async onRetrieverEnd(e){await this._updateRunSingle(e)}async onRetrieverError(e){await this._updateRunSingle(e)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}async function jd(){return new Nd}let ia;function $d(){const r="default"in Be?Be.default:Be;return new r({autoStart:!0,concurrency:1})}async function ee(r,e){e===!0?await r():(typeof ia>"u"&&(ia=$d()),ia.add(r))}class Ld{setHandler(e){return this.setHandlers([e])}}class Bn{constructor(e,t,n,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;try{await((n=t.handleText)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleText: ${a}`)}},t.awaitHandlers)))}}class Md extends Bn{getChild(e){const t=new de(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreRetriever)try{await((n=t.handleRetrieverEnd)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreRetriever)try{await((n=t.handleRetrieverError)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`)}},t.awaitHandlers)))}}class Ws extends Bn{async handleLLMNewToken(e,t,n,a,s,i){await Promise.all(this.handlers.map(o=>ee(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreLLM)try{await((n=t.handleLLMError)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${a}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreLLM)try{await((n=t.handleLLMEnd)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${a}`)}},t.awaitHandlers)))}}class Dd extends Bn{getChild(e){const t=new de(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,a,s){await Promise.all(this.handlers.map(i=>ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${u}`)}},i.awaitHandlers)))}async handleChainEnd(e,t,n,a,s){await Promise.all(this.handlers.map(i=>ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreAgent)try{await((n=t.handleAgentAction)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreAgent)try{await((n=t.handleAgentEnd)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`)}},t.awaitHandlers)))}}class Fd extends Bn{getChild(e){const t=new de(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreAgent)try{await((n=t.handleToolError)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${a}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var n;if(!t.ignoreAgent)try{await((n=t.handleToolEnd)==null?void 0:n.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`)}},t.awaitHandlers)))}}class de extends Ld{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}async handleLLMStart(e,t,n=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=Ue();return await Promise.all(this.handlers.map(d=>ee(async()=>{var h;if(!d.ignoreLLM)try{await((h=d.handleLLMStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u))}catch(m){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${m}`)}},d.awaitHandlers))),new Ws(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{const l=Ue();return await Promise.all(this.handlers.map(d=>ee(async()=>{var h,m;if(!d.ignoreLLM)try{if(d.handleChatModelStart)await((h=d.handleChatModelStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u));else if(d.handleLLMStart){const f=Si(c);await((m=d.handleLLMStart)==null?void 0:m.call(d,e,[f],l,this._parentRunId,s,this.tags,this.metadata,u))}}catch(f){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`)}},d.awaitHandlers))),new Ws(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=Ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreChain)try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,n,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`)}},u.awaitHandlers))),new Dd(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=Ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreAgent)try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,n,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`)}},u.awaitHandlers))),new Fd(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=Ue(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreRetriever)try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,n,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`)}},u.awaitHandlers))),new Md(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new de(this._parentRunId);for(const a of this.handlers){const s=this.inheritableHandlers.includes(a);n.addHandler(a,s)}for(const a of this.tags){const s=this.inheritableTags.includes(a);n.addTags([a],s)}for(const a of Object.keys(this.metadata)){const s=Object.keys(this.inheritableMetadata).includes(a);n.addMetadata({[a]:this.metadata[a]},s)}for(const a of e)n.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||n.addHandler(a,t);return n}static fromHandlers(e){class t extends Pr{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ue()}),Object.assign(this,e)}}const n=new this;return n.addHandler(new t),n}static async configure(e,t,n,a,s,i,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new de,u.setHandlers((e==null?void 0:e.map(kn))??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(kn):t==null?void 0:t.handlers,!1));const c=we("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=we("LANGCHAIN_TRACING_V2")==="true",d=l||(we("LANGCHAIN_TRACING")??!1);if(c||d){if(u||(u=new de),c&&!u.handlers.some(h=>h.name===Vs.prototype.name)){const h=new Vs;u.addHandler(h,!0)}d&&!u.handlers.some(h=>h.name==="langchain_tracer")&&l&&u.addHandler(await jd(),!0)}return(n||a)&&u&&(u.addTags(n??[]),u.addTags(a??[],!1)),(s||i)&&u&&(u.addMetadata(s??{}),u.addMetadata(i??{},!1)),u}}function kn(r){return"name"in r?r:Pr.fromMethods(r)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const Ud=Object.prototype.hasOwnProperty;function Bd(r,e){return Ud.call(r,e)}function Zd(r){if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(r);let e=[];for(let t in r)Bd(r,t)&&e.push(t);return e}function qt(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function ka(r){let e=0;const t=r.length;let n;for(;e<t;){if(n=r.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function Vd(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function Ta(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(Ta(r[t]))return!0}else if(typeof r=="object"){const t=Zd(r),n=t.length;for(var e=0;e<n;e++)if(Ta(r[t[e]]))return!0}}return!1}function Ks(r,e){const t=[r];for(const n in e){const a=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof a<"u"&&t.push(`${n}: ${a}`)}return t.join(`
`)}class zd extends Error{constructor(e,t,n,a,s){super(Ks(e,{name:t,index:n,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=Ks(e,{name:t,index:n,operation:a,tree:s})}}const W=zd,Ct={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var n=r[e];return delete r[e],{newDocument:t,removed:n}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:function(r,e,t){let n=Sa(t,this.path);n&&(n=qt(n));const a=ir(t,{op:"remove",path:this.from}).removed;return ir(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:n}},copy:function(r,e,t){const n=Sa(t,this.from);return ir(t,{op:"add",path:this.path,value:qt(n)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:Tn(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}};var Hd={add:function(r,e,t){return ka(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var n=r.splice(e,1);return{newDocument:t,removed:n[0]}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:Ct.move,copy:Ct.copy,test:Ct.test,_get:Ct._get};function Sa(r,e){if(e=="")return r;var t={op:"_get",path:e};return ir(r,t),t.value}function ir(r,e,t=!1,n=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,r,e.path):Ca(e,0)),e.path===""){let i={newDocument:r};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=r,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Sa(r,e.from),e.op==="move"&&(i.removed=r),i;if(e.op==="test"){if(i.test=Tn(r,e.value),i.test===!1)throw new W("Test operation failed","TEST_OPERATION_FAILED",s,e,r);return i.newDocument=r,i}else{if(e.op==="remove")return i.removed=r,i.newDocument=null,i;if(e.op==="_get")return e.value=r,i;if(t)throw new W("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,r);return i}}else{n||(r=qt(r));const o=(e.path||"").split("/");let u=r,c=1,l=o.length,d,h,m;for(typeof t=="function"?m=t:m=Ca;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=Vd(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&m(e,0,r,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!ka(h))throw new W("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,r);ka(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new W("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,r);const f=Hd[e.op].call(e,u,h,r);if(f.test===!1)throw new W("Test operation failed","TEST_OPERATION_FAILED",s,e,r);return f}}else if(c>=l){const f=Ct[e.op].call(e,u,h,r);if(f.test===!1)throw new W("Test operation failed","TEST_OPERATION_FAILED",s,e,r);return f}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new W("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,r)}}}function us(r,e,t,n=!0,a=!0){if(t&&!Array.isArray(e))throw new W("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(r=qt(r));const s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=ir(r,e[i],t,!0,a,i),r=s[i].newDocument;return s.newDocument=r,s}function Ca(r,e,t,n){if(typeof r!="object"||r===null||Array.isArray(r))throw new W("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(Ct[r.op]){if(typeof r.path!="string")throw new W("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new W('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new W("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new W("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&Ta(r.value))throw new W("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var a=r.path.split("/").length,s=n.split("/").length;if(a!==s+1&&a!==s)throw new W("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==n)throw new W("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var i={op:"_get",path:r.from,value:void 0},o=qd([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new W("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new W("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function qd(r,e,t){try{if(!Array.isArray(r))throw new W("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)us(qt(e),qt(r),t||!0);else{t=t||Ca;for(var n=0;n<r.length;n++)t(r[n],n,e,void 0)}}catch(a){if(a instanceof W)return a;throw a}}function Tn(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),n=Array.isArray(e),a,s,i;if(t&&n){if(s=r.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!Tn(r[a],e[a]))return!1;return!0}if(t!=n)return!1;var o=Object.keys(r);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!Tn(r[i],e[i]))return!1;return!0}return r!==r&&e!==e}class qe extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new qe({start(n){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){n.close();return}return n.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new qe({async pull(t){const{value:n,done:a}=await e.next();a&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function fo(r,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const s=await r.next();for(const i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Dt(r,e){if(Array.isArray(r)&&Array.isArray(e))return r.concat(e);if(typeof r=="string"&&typeof e=="string")return r+e;if(typeof r=="number"&&typeof e=="number")return r+e;if("concat"in r&&typeof r.concat=="function")return r.concat(e);if(typeof r=="object"&&typeof e=="object"){const t={...r};for(const[n,a]of Object.entries(e))n in t?t[n]=Dt(t[n],a):t[n]=a;return t}else throw new Error(`Cannot concat ${typeof r} and ${typeof e}`)}class Jt{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((n,a)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(n,a):this.firstResult.then(s=>n(void 0),a)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function Wd(r,e,t,...n){const a=new Jt(e,t),s=await a.setup;return{output:r(a,s,...n),setup:s}}class Qe{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops}concat(e){const t=this.ops.concat(e.ops),n=us({},t);return new cs({ops:t,state:n[n.length-1].newDocument})}}class cs extends Qe{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=us(this.state,e.ops);return new cs({ops:t,state:n[n.length-1].newDocument})}}class Kd extends Un{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=qe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new Qe({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){var a;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Qe({ops:[{op:"replace",path:"",value:{id:e.id,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((a=e.extra)==null?void 0:a.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};await this.writer.write(new Qe({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const n=[{op:"add",path:`/logs/${t}/final_output`,value:e.outputs}];e.end_time!==void 0&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new Qe({ops:n});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new Qe({ops:[{op:"replace",path:"/final_output",value:e.outputs}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t){const n=this.keyMapByRunId[e.id];if(n===void 0)return;const a=new Qe({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t}]});await this.writer.write(a)}}const Js=25;async function yt(r){return de.configure(r==null?void 0:r.callbacks,void 0,r==null?void 0:r.tags,void 0,r==null?void 0:r.metadata)}function Gs(...r){const e=Ye();for(const t of r.filter(n=>!!n))for(const n of Object.keys(t))if(n==="metadata")e[n]={...e[n],...t[n]};else if(n==="tags")e[n]=[...new Set(e[n].concat(t[n]??[]))];else if(n==="configurable")e[n]={...e[n],...t[n]};else if(n==="callbacks"){const a=e.callbacks,s=t.callbacks;if(Array.isArray(s))if(!a)e.callbacks=s;else if(Array.isArray(a))e.callbacks=a.concat(s);else{const i=a.copy();for(const o of s)i.addHandler(kn(o),!0);e.callbacks=i}else if(s)if(!a)e.callbacks=s;else if(Array.isArray(a)){const i=s.copy();for(const o of a)i.addHandler(kn(o),!0);e.callbacks=i}else e.callbacks=new de(s._parentRunId,{handlers:a.handlers.concat(s.handlers),inheritableHandlers:a.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(s.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(s.inheritableTags))),metadata:{...a.metadata,...s.metadata}})}else{const a=n;e[a]=t[a]??e[a]}return e}const Jd=new Set(["string","number","boolean"]);function Ye(r){var t;let e={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(r&&(e={...e,...r}),r!=null&&r.configurable)for(const n of Object.keys(r.configurable))Jd.has(typeof r.configurable[n])&&!((t=e.metadata)!=null&&t[n])&&(e.metadata||(e.metadata={}),e.metadata[n]=r.configurable[n]);return e}function ce(r={},{callbacks:e,maxConcurrency:t,recursionLimit:n,runName:a,configurable:s}={}){const i=Ye(r);return e!==void 0&&(delete i.runName,i.callbacks=e),n!==void 0&&(i.recursionLimit=n),t!==void 0&&(i.maxConcurrency=t),a!==void 0&&(i.runName=a),s!==void 0&&(i.configurable={...i.configurable,...s}),i}class mo extends Un{constructor({config:e,onStart:t,onEnd:n,onError:a}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function ne(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}class he extends xt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Ft({bound:this,kwargs:e,config:{}})}map(){return new Sn({bound:this})}withRetry(e){return new Gd({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Ft({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Xd({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(Ye)}return Array.from({length:t},()=>Ye(e))}async batch(e,t,n){var u;const a=this._getOptionsList(t??{},e.length),s=((u=a[0])==null?void 0:u.maxConcurrency)??(n==null?void 0:n.maxConcurrency),i=new ss({maxConcurrency:s,onFailedAttempt:c=>{throw c}}),o=e.map((c,l)=>i.call(async()=>{try{return await this.invoke(c,a[l])}catch(d){if(n!=null&&n.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=new Jt(this._streamIterator(e,t));return await n.setup,qe.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e={}){const t=Ye({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,[t,n]}async _callWithConfig(e,t,n){const a=Ye(n),s=await yt(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),ne(t,"input"),void 0,a==null?void 0:a.runType,void 0,void 0,(a==null?void 0:a.runName)??this.getName()));let o;try{o=await e.call(this,t,a,i)}catch(u){throw await(i==null?void 0:i.handleChainError(u)),u}return await(i==null?void 0:i.handleChainEnd(ne(o,"output"))),o}async _batchWithConfig(e,t,n,a){const s=this._getOptionsList(n??{},t.length),i=await Promise.all(s.map(yt)),o=await Promise.all(i.map((c,l)=>c==null?void 0:c.handleChainStart(this.toJSON(),ne(t[l],"input"),void 0,s[l].runType,void 0,void 0,s[l].runName??this.getName())));let u;try{u=await e.call(this,t,s,o,a)}catch(c){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(o.map(c=>c==null?void 0:c.handleChainEnd(ne(u,"output")))),u}async*_transformStreamWithConfig(e,t,n){let a,s=!0,i,o=!0;const u=Ye(n),c=await yt(u);async function*l(){for await(const h of e){if(s)if(a===void 0)a=h;else try{a=Dt(a,h)}catch{a=void 0,s=!1}yield h}}let d;try{const h=await Wd(t.bind(this),l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(u==null?void 0:u.runName)??this.getName()),u);d=h.setup;const m=p=>p.name==="log_stream_tracer",f=d==null?void 0:d.handlers.find(m);let v=h.output;f!==void 0&&d!==void 0&&(v=await f.tapOutputIterable(d.runId,h.output));for await(const p of v)if(yield p,o)if(i===void 0)i=p;else try{i=Dt(i,p)}catch{i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:ne(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:ne(a,"input")}))}pipe(e){return new It({first:this,last:mt(e)})}pick(e){return this.pipe(new Yd(e))}assign(e){return this.pipe(new Qd(new kr({steps:e})))}async*transform(e,t){let n;for await(const a of e)n===void 0?n=a:n=Dt(n,a);yield*this._streamIterator(n,t)}async*streamLog(e,t,n){const a=new Kd({...n,autoClose:!1}),s=Ye(t),{callbacks:i}=s;if(i===void 0)s.callbacks=[a];else if(Array.isArray(i))s.callbacks=i.concat([a]);else{const l=i.copy();l.inheritableHandlers.push(a),s.callbacks=l}const o=this.stream(e,s);async function u(){try{const l=await o;for await(const d of l){const h=new Qe({ops:[{op:"add",path:"/streamed_output/-",value:d}]});await a.writer.write(h)}}finally{await a.writer.close()}}const c=u();try{for await(const l of a)yield l}finally{await c}}static isRunnable(e){return e?e.lc_runnable:!1}withListeners({onStart:e,onEnd:t,onError:n}){return new Ft({bound:this,config:{},configFactories:[a=>({callbacks:[new mo({config:a,onStart:e,onEnd:t,onError:n})]})]})}}class Ft extends he{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Gs(this.config,...e);return Gs(t,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,n){const a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(s,this.kwargs))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,a,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}static isRunnableBinding(e){return e.bound&&he.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new Ft({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new mo({config:a,onStart:e,onEnd:t,onError:n})]})]})}}class Sn extends he{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Sn({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,ce(t,{callbacks:n==null?void 0:n.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new Sn({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class Gd extends Ft{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const a=e>1?`retry:attempt:${e}`:void 0;return ce(t,{callbacks:n==null?void 0:n.getChild(a)})}async _invoke(e,t,n){return Pn(a=>super.invoke(e,this._patchConfigForRetry(a,t,n)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,a){const s={};try{await Pn(async i=>{const o=e.map((h,m)=>m).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],n==null?void 0:n[h])),l=await super.batch(u,c,{...a,returnExceptions:!0});let d;for(let h=0;h<l.length;h+=1){const m=l[h],f=o[h];m instanceof Error&&d===void 0&&(d=m),s[f.toString()]=m}if(d)throw d;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class It extends he{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=await yt(t),a=await(n==null?void 0:n.handleChainStart(this.toJSON(),ne(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let s=e,i;try{const o=[this.first,...this.middle];for(let u=0;u<o.length;u+=1)s=await o[u].invoke(s,ce(t,{callbacks:a==null?void 0:a.getChild(`seq:step:${u+1}`)}));i=await this.last.invoke(s,ce(t,{callbacks:a==null?void 0:a.getChild(`seq:step:${this.steps.length}`)}))}catch(o){throw await(a==null?void 0:a.handleChainError(o)),o}return await(a==null?void 0:a.handleChainEnd(ne(i,"output"))),i}async batch(e,t,n){const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(yt)),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),ne(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName)));let o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((l,d)=>{const h=l==null?void 0:l.getChild(`seq:step:${u+1}`);return ce(a[d],{callbacks:h})}),n)}catch(u){throw await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(u))),u}return await Promise.all(i.map(u=>u==null?void 0:u.handleChainEnd(ne(o,"output")))),o}async*_streamIterator(e,t){const n=await yt(t),a=await(n==null?void 0:n.handleChainStart(this.toJSON(),ne(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),s=[this.first,...this.middle,this.last];let i=!0,o;async function*u(){yield e}try{let c=s[0].transform(u(),ce(t,{callbacks:a==null?void 0:a.getChild("seq:step:1")}));for(let l=1;l<s.length;l+=1)c=await s[l].transform(c,ce(t,{callbacks:a==null?void 0:a.getChild(`seq:step:${l+1}`)}));for await(const l of c)if(yield l,i)if(o===void 0)o=l;else try{o=Dt(o,l)}catch{o=void 0,i=!1}}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}await(a==null?void 0:a.handleChainEnd(ne(o,"output")))}pipe(e){return It.isRunnableSequence(e)?new It({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new It({first:this.first,middle:[...this.middle,this.last],last:mt(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&he.isRunnable(e)}static from([e,...t],n){return new It({first:mt(e),middle:t.slice(0,-1).map(mt),last:mt(t[t.length-1]),name:n})}}class kr extends he{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=mt(n)}static from(e){return new kr({steps:e})}async invoke(e,t){const n=await yt(t),a=await(n==null?void 0:n.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),s={};try{await Promise.all(Object.entries(this.steps).map(async([i,o])=>{s[i]=await o.invoke(e,ce(t,{callbacks:a==null?void 0:a.getChild(`map:key:${i}`)}))}))}catch(i){throw await(a==null?void 0:a.handleChainError(i)),i}return await(a==null?void 0:a.handleChainEnd(s)),s}async*_transform(e,t,n){const a={...this.steps},s=fo(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{const l=u.transform(s[c],ce(n,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){const{key:o,result:u,gen:c}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,c.next().then(l=>({key:o,gen:c,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const a=new Jt(this.transform(n(),t));return await a.setup,qe.fromAsyncGenerator(a)}}class ls extends he{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new ls({func:e})}async _invoke(e,t,n){let a=await this.func(e,{...t,config:t});if(a&&he.isRunnable(a)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");a=await a.invoke(e,ce(t,{callbacks:n==null?void 0:n.getChild(),recursionLimit:((t==null?void 0:t.recursionLimit)??Js)-1}))}return a}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let a;for await(const i of e)if(a===void 0)a=i;else try{a=Dt(a,i)}catch{a=i}const s=await this.func(a,{...n,config:n});if(s&&he.isRunnable(s)){if((n==null?void 0:n.recursionLimit)===0)throw new Error("Recursion limit reached.");const i=await s.stream(a,ce(n,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((n==null?void 0:n.recursionLimit)??Js)-1}));for await(const o of i)yield o}else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const a=new Jt(this.transform(n(),t));return await a.setup,qe.fromAsyncGenerator(a)}}class Xd extends he{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=await de.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),a=await(n==null?void 0:n.handleChainStart(this.toJSON(),ne(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let s;for(const i of this.runnables())try{const o=await i.invoke(e,ce(t,{callbacks:a==null?void 0:a.getChild()}));return await(a==null?void 0:a.handleChainEnd(ne(o,"output"))),o}catch(o){s===void 0&&(s=o)}throw s===void 0?new Error("No error stored at end of fallback."):(await(a==null?void 0:a.handleChainError(s)),s)}async batch(e,t,n){if(n!=null&&n.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),s=await Promise.all(a.map(u=>de.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),ne(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName)));let o;for(const u of this.runnables())try{const c=await u.batch(e,i.map((l,d)=>ce(a[d],{callbacks:l==null?void 0:l.getChild()})),n);return await Promise.all(i.map((l,d)=>l==null?void 0:l.handleChainEnd(ne(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function mt(r){if(typeof r=="function")return new ls({func:r});if(he.isRunnable(r))return r;if(!Array.isArray(r)&&typeof r=="object"){const e={};for(const[t,n]of Object.entries(r))e[t]=mt(n);return new kr({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class Qd extends he{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof kr&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const a=this.mapper.getStepsKeys(),[s,i]=fo(e),o=this.mapper.transform(i,ce(n,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(const c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(const c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const a=new Jt(this.transform(n(),t));return await a.setup,qe.fromAsyncGenerator(a)}}class Yd extends he{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const n=await this._pick(t);n!==void 0&&(yield n)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}const a=new Jt(this.transform(n(),t));return await a.setup,qe.fromAsyncGenerator(a)}}const eh=r=>r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r,th=()=>!1;class rh extends he{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??th(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class nh extends rh{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n.cache=="object"?this.cache=n.cache:n.cache?this.cache=rs.global():this.cache=void 0,this.caller=new ss(n??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await cd("modelName"in this?eh(this.modelName):"gpt2")}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new El(e):Array.isArray(e)?new Ol(e.map(Xt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([s,i])=>i!==void 0).map(([s,i])=>`${s}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class ft extends nh{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n!=null&&n.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=ft._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===ft.prototype._streamResponseChunks)yield this.invoke(e,t);else{const a=ft._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o=await de.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[a],void 0,void 0,u,void 0,void 0,s.runName));let l;try{for await(const d of this._streamResponseChunks(a,i,c==null?void 0:c[0]))yield d.message,l?l=l.concat(d):l=d}catch(d){throw await Promise.all((c??[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[l]]})))}}async _generateUncached(e,t,n){var h;const a=e.map(m=>m.map(Xt)),s=await de.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(s==null?void 0:s.handleChatModelStart(this.toJSON(),a,void 0,void 0,i,void 0,void 0,n.runName)),u=await Promise.allSettled(a.map((m,f)=>this._generate(m,{...t,promptIndex:f},o==null?void 0:o[f]))),c=[],l=[];await Promise.all(u.map(async(m,f)=>{var v,p;if(m.status==="fulfilled"){const E=m.value;return c[f]=E.generations,l[f]=E.llmOutput,(v=o==null?void 0:o[f])==null?void 0:v.handleLLMEnd({generations:[E.generations],llmOutput:E.llmOutput})}else return await((p=o==null?void 0:o[f])==null?void 0:p.handleLLMError(m.reason)),Promise.reject(m.reason)}));const d={generations:c,llmOutput:l.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...l):void 0};return Object.defineProperty(d,Us,{value:o?{runIds:o==null?void 0:o.map(m=>m.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:a,handledOptions:s}){const i=e.map(v=>v.map(Xt)),o=await de.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),u={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1,cached:!0},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),i,void 0,void 0,u,void 0,void 0,s.runName)),l=[],h=(await Promise.allSettled(i.map(async(v,p)=>{const E=ft._convertInputToPromptValue(v).toString(),k=await t.lookup(E,n);return k==null&&l.push(p),k}))).map((v,p)=>({result:v,runManager:c==null?void 0:c[p]})).filter(({result:v})=>v.status==="fulfilled"&&v.value!=null||v.status==="rejected"),m=[];await Promise.all(h.map(async({result:v,runManager:p},E)=>{if(v.status==="fulfilled"){const k=v.value;return m[E]=k,k.length&&await(p==null?void 0:p.handleLLMNewToken(k[0].text)),p==null?void 0:p.handleLLMEnd({generations:[k]})}else return await(p==null?void 0:p.handleLLMError(v.reason)),Promise.reject(v.reason)}));const f={generations:m,missingPromptIndices:l};return Object.defineProperty(f,Us,{value:c?{runIds:c==null?void 0:c.map(v=>v.runId)}:void 0,configurable:!0}),f}async generate(e,t,n){let a;Array.isArray(t)?a={stop:t}:a=t;const s=e.map(m=>m.map(Xt)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=i.callbacks??n,!this.cache)return this._generateUncached(s,o,i);const{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d}=await this._generateCached({messages:s,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i});let h={};if(d.length>0){const m=await this._generateUncached(d.map(f=>s[f]),o,i);await Promise.all(m.generations.map(async(f,v)=>{const p=d[v];l[p]=f;const E=ft._convertInputToPromptValue(s[p]).toString();return u.update(E,c,f)})),h=m.llmOutput??{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const a=e.map(s=>s.toChatMessages());return this.generate(a,t,n)}async call(e,t,n){return(await this.generate([e.map(Xt)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const a=e.toChatMessages();return this.call(a,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const a=new hr(e),s=await this.call([a],t,n);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}}function po(r,e,t,n){n!=null&&n.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function M(r,e,t,n,a){r[e]=t,po(r,e,n,a)}const Xs={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},ah=r=>typeof r=="string"?{...Xs,name:r}:{...Xs,...r};function sh(){return{}}function ih(r,e){var n,a;const t={type:"array"};return((a=(n=r.type)==null?void 0:n._def)==null?void 0:a.typeName)!==g.ZodAny&&(t.items=$(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&M(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&M(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(M(t,"minItems",r.exactLength.value,r.exactLength.message,e),M(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function oh(r,e){const t={type:"integer",format:"int64"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?M(t,"minimum",n.value,n.message,e):M(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),M(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?M(t,"maximum",n.value,n.message,e):M(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),M(t,"maximum",n.value,n.message,e));break;case"multipleOf":M(t,"multipleOf",n.value,n.message,e);break}return t}function uh(){return{type:"boolean"}}function ch(r,e){return $(r.type._def,e)}const lh=(r,e)=>$(r.innerType._def,e);function dh(r,e){return e.dateStrategy=="integer"?hh(r,e):{type:"string",format:"date-time"}}const hh=(r,e)=>{const t={type:"integer",format:"unix-time"};for(const n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"&&M(t,"minimum",n.value,n.message,e);break;case"max":e.target==="jsonSchema7"&&M(t,"maximum",n.value,n.message,e);break}return t};function fh(r,e){return{...$(r.innerType._def,e),default:r.defaultValue()}}function mh(r,e){return e.effectStrategy==="input"?$(r.schema._def,e):{}}function ph(r){return{type:"string",enum:r.values}}const gh=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function yh(r,e){const t=[$(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),$(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(s=>{if(gh(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(n=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:o,...u}=s;i=u}else n=void 0;a.push(i)}}),a.length?{allOf:a,...n}:void 0}function bh(r,e){const t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}const Gt={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function go(r,e){const t={type:"string"};function n(a){return e.patternStrategy==="escape"?_h(a):a}if(r.checks)for(const a of r.checks)switch(a.kind){case"min":M(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":M(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ht(t,"email",a.message,e);break;case"format:idn-email":ht(t,"idn-email",a.message,e);break;case"pattern:zod":De(t,Gt.email,a.message,e);break}break;case"url":ht(t,"uri",a.message,e);break;case"uuid":ht(t,"uuid",a.message,e);break;case"regex":De(t,a.regex.source,a.message,e);break;case"cuid":De(t,Gt.cuid,a.message,e);break;case"cuid2":De(t,Gt.cuid2,a.message,e);break;case"startsWith":De(t,"^"+n(a.value),a.message,e);break;case"endsWith":De(t,n(a.value)+"$",a.message,e);break;case"datetime":ht(t,"date-time",a.message,e);break;case"length":M(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),M(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{De(t,n(a.value),a.message,e);break}case"ip":{a.version!=="v6"&&ht(t,"ipv4",a.message,e),a.version!=="v4"&&ht(t,"ipv6",a.message,e);break}case"emoji":De(t,Gt.emoji,a.message,e);break;case"ulid":{De(t,Gt.ulid,a.message,e);break}}return t}const _h=r=>Array.from(r).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),ht=(r,e,t,n)=>{var a;r.format||(a=r.anyOf)!=null&&a.some(s=>s.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):M(r,"format",e,t,n)},De=(r,e,t,n)=>{var a;r.pattern||(a=r.allOf)!=null&&a.some(s=>s.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:e,...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):M(r,"pattern",e,t,n)};function yo(r,e){var n,a,s,i;if(e.target==="openApi3"&&((n=r.keyType)==null?void 0:n._def.typeName)===g.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((o,u)=>({...o,[u]:$(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:$(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=r.keyType)==null?void 0:a._def.typeName)===g.ZodString&&((s=r.keyType._def.checks)!=null&&s.length)){const o=Object.entries(go(r.keyType._def,e)).reduce((u,[c,l])=>c==="type"?u:{...u,[c]:l},{});return{...t,propertyNames:o}}else if(((i=r.keyType)==null?void 0:i._def.typeName)===g.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};return t}function vh(r,e){if(e.mapStrategy==="record")return yo(r,e);const t=$(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=$(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function wh(r){const e=r.values,n=Object.keys(r.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(n.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:n}}function xh(){return{not:{}}}function Ah(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Cn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Eh(r,e){if(e.target==="openApi3")return Qs(r,e);const t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in Cn&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((a,s)=>{const i=Cn[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((a,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(n.length===t.length){const a=n.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,a)=>[...n,...a._def.values.filter(s=>!n.includes(s))],[])};return Qs(r,e)}const Qs=(r,e)=>{const t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,a)=>$(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function Oh(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"?{type:Cn[r.innerType._def.typeName],nullable:!0}:{type:[Cn[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=$(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=$(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Ph(r,e){const t={type:"number"};if(!r.checks)return t;for(const n of r.checks)switch(n.kind){case"int":t.type="integer",po(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?M(t,"minimum",n.value,n.message,e):M(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),M(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?M(t,"maximum",n.value,n.message,e):M(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),M(t,"maximum",n.value,n.message,e));break;case"multipleOf":M(t,"multipleOf",n.value,n.message,e);break}return t}function kh(r,e){const t={type:"object",...Object.entries(r.shape()).reduce((n,[a,s])=>{if(s===void 0||s._def===void 0)return n;const i=$(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?n:{properties:{...n.properties,[a]:i},required:s.isOptional()?n.required:[...n.required,a]}},{properties:{},required:[]}),additionalProperties:r.catchall._def.typeName==="ZodNever"?r.unknownKeys==="passthrough":$(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0};return t.required.length||delete t.required,t}const Th=(r,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return $(r.innerType._def,e);const t=$(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Sh=(r,e)=>{if(e.pipeStrategy==="input")return $(r.in._def,e);if(e.pipeStrategy==="output")return $(r.out._def,e);const t=$(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=$(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(a=>a!==void 0)}};function Ch(r,e){return $(r.type._def,e)}function Ih(r,e){const n={type:"array",uniqueItems:!0,items:$(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&M(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&M(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function Rh(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>$(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:$(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>$(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function Nh(){return{not:{}}}function jh(){return{}}const $h=(r,e)=>$(r.innerType._def,e);function $(r,e,t=!1){const n=e.seen.get(r);if(n&&!t){const i=Lh(n,e);if(i!==void 0)return i}const a={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,a);const s=Dh(r,r.typeName,e);return s&&Fh(r,e,s),a.jsonSchema=s,s}const Lh=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"relative":return{$ref:Mh(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Mh=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")},Dh=(r,e,t)=>{switch(e){case g.ZodString:return go(r,t);case g.ZodNumber:return Ph(r,t);case g.ZodObject:return kh(r,t);case g.ZodBigInt:return oh(r,t);case g.ZodBoolean:return uh();case g.ZodDate:return dh(r,t);case g.ZodUndefined:return Nh();case g.ZodNull:return Ah(t);case g.ZodArray:return ih(r,t);case g.ZodUnion:case g.ZodDiscriminatedUnion:return Eh(r,t);case g.ZodIntersection:return yh(r,t);case g.ZodTuple:return Rh(r,t);case g.ZodRecord:return yo(r,t);case g.ZodLiteral:return bh(r,t);case g.ZodEnum:return ph(r);case g.ZodNativeEnum:return wh(r);case g.ZodNullable:return Oh(r,t);case g.ZodOptional:return Th(r,t);case g.ZodMap:return vh(r,t);case g.ZodSet:return Ih(r,t);case g.ZodLazy:return $(r.getter()._def,t);case g.ZodPromise:return Ch(r,t);case g.ZodNaN:case g.ZodNever:return xh();case g.ZodEffects:return mh(r,t);case g.ZodAny:return sh();case g.ZodUnknown:return jh();case g.ZodDefault:return fh(r,t);case g.ZodBranded:return ch(r,t);case g.ZodReadonly:return $h(r,t);case g.ZodCatch:return lh(r,t);case g.ZodPipeline:return Sh(r,t);case g.ZodFunction:case g.ZodVoid:case g.ZodSymbol:return;default:return(n=>{})()}},Fh=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t),Uh=r=>{const e=ah(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}},Bh=(r,e)=>{const t=Uh(e),n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((o,[u,c])=>({...o,[u]:$(c._def,{...t,currentPath:[...t.basePath,t.definitionPath,u]},!0)??{}}),{}):void 0,a=typeof e=="string"?e:e==null?void 0:e.name,s=$(r._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1)??{},i=a===void 0?n?{...s,[t.definitionPath]:n}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...n,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function Zh(r){return{name:r.name,description:r.description,parameters:Bh(r.schema)}}function Vh(r){return{type:"function",function:Zh(r)}}function zh(r){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:a,baseURL:s}=r;if(n&&a&&e)return`${a}/${e}`;if(n){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function Hh(r){let e;return r.constructor.name===dl.name?(e=new Error(r.message),e.name="TimeoutError"):r.constructor.name===hl.name?(e=new Error(r.message),e.name="AbortError"):e=r,e}function qh(r){return r.anyOf!==void 0&&Array.isArray(r.anyOf)}function Wh(r){const e=["namespace functions {",""];for(const t of r)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(bo(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function bo(r,e){var n;const t=[];for(const[a,s]of Object.entries(r.properties??{}))s.description&&e<2&&t.push(`// ${s.description}`),(n=r.required)!=null&&n.includes(a)?t.push(`${a}: ${In(s,e)},`):t.push(`${a}?: ${In(s,e)},`);return t.map(a=>" ".repeat(e)+a).join(`
`)}function In(r,e){if(qh(r))return r.anyOf.map(t=>In(t,e)).join(" | ");switch(r.type){case"string":return r.enum?r.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",bo(r,e+2),"}"].join(`
`);case"array":return r.items?`${In(r.items,e)}[]`:"any[]";default:return""}}function Kh(r){return r.role!=="system"&&r.role!=="assistant"&&r.role!=="user"&&r.role!=="function"&&r.role!=="tool"&&console.warn(`Unknown message role: ${r.role}`),r.role}function _o(r){const e=r._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Er.isInstance(r))throw new Error("Invalid generic chat message");return Kh(r)}default:throw new Error(`Unknown message type: ${e}`)}}function Jh(r){switch(r.role){case"assistant":return new ja(r.content||"",{function_call:r.function_call,tool_calls:r.tool_calls});default:return new Er(r.content||"",r.role??"unknown")}}function Gh(r,e){const t=r.role??e,n=r.content??"";let a;return r.function_call?a={function_call:r.function_call}:r.tool_calls?a={tool_calls:r.tool_calls}:a={},t==="user"?new fr({content:n}):t==="assistant"?new mr({content:n,additional_kwargs:a}):t==="system"?new pr({content:n}):t==="function"?new gr({content:n,additional_kwargs:a,name:r.name}):t==="tool"?new en({content:n,additional_kwargs:a,tool_call_id:r.tool_call_id}):new yr({content:n,role:t})}function Ys(r){return r.map(e=>({role:_o(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}class Xh extends ft{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var n,a,s,i,o,u,c,l;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.openAIApiKey)??we("OPENAI_API_KEY"),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??we("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??we("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??we("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??we("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??we("AZURE_OPENAI_BASE_PATH"),this.organization=((n=e==null?void 0:e.configuration)==null?void 0:n.organization)??we("OPENAI_ORGANIZATION"),this.modelName=(e==null?void 0:e.modelName)??this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(e==null?void 0:e.streaming)??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(t==null?void 0:t.basePath)??((a=e==null?void 0:e.configuration)==null?void 0:a.basePath),dangerouslyAllowBrowser:!0,defaultHeaders:((s=t==null?void 0:t.baseOptions)==null?void 0:s.headers)??((o=(i=e==null?void 0:e.configuration)==null?void 0:i.baseOptions)==null?void 0:o.headers),defaultQuery:((u=t==null?void 0:t.baseOptions)==null?void 0:u.params)??((l=(c=e==null?void 0:e.configuration)==null?void 0:c.baseOptions)==null?void 0:l.params),...t,...e==null?void 0:e.configuration}}invocationParams(e){function t(a){return a!==void 0&&a.every(s=>Array.isArray(s.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(Vh):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){var u;const a=Ys(e),s={...this.invocationParams(t),messages:a,stream:!0};let i;const o=await this.completionWithRetry(s,t);for await(const c of o){const l=c==null?void 0:c.choices[0];if(!l)continue;const{delta:d}=l;if(!d)continue;const h=Gh(d,i);i=d.role??i;const m={prompt:t.promptIndex??0,completion:l.index??0};if(typeof h.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const f=new ts({message:h,text:h.content,generationInfo:m});yield f,n==null||n.handleLLMNewToken(f.text??"",m,void 0,void 0,void 0,{chunk:f})}if((u=t.signal)!=null&&u.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){var o,u;const a={},s=this.invocationParams(t),i=Ys(e);if(s.stream){const c=this._streamResponseChunks(e,t,n),l={};for await(const p of c){const E=((o=p.generationInfo)==null?void 0:o.completion)??0;l[E]===void 0?l[E]=p:l[E]=l[E].concat(p)}const d=Object.entries(l).sort(([p],[E])=>parseInt(p,10)-parseInt(E,10)).map(([p,E])=>E),{functions:h,function_call:m}=this.invocationParams(t),f=await this.getEstimatedTokenCountFromPrompt(e,h,m),v=await this.getNumTokensFromGenerations(d);return a.promptTokens=f,a.completionTokens=v,a.totalTokens=f+v,{generations:d,llmOutput:{estimatedTokenUsage:a}}}else{const c=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:l,prompt_tokens:d,total_tokens:h}=(c==null?void 0:c.usage)??{};l&&(a.completionTokens=(a.completionTokens??0)+l),d&&(a.promptTokens=(a.promptTokens??0)+d),h&&(a.totalTokens=(a.totalTokens??0)+h);const m=[];for(const f of(c==null?void 0:c.choices)??[]){const p={text:((u=f.message)==null?void 0:u.content)??"",message:Jh(f.message??{role:"assistant"})};p.generationInfo={...f.finish_reason?{finish_reason:f.finish_reason}:{},...f.logprobs?{logprobs:f.logprobs}:{}},m.push(p)}return{generations:m,llmOutput:{tokenUsage:a}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){const s=Wh(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),n==="none"?a+=1:typeof n=="object"&&(a+=await this.getNumTokens(n.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>{var a;return(a=n.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)}))).reduce((n,a)=>n+a,0)}async getNumTokensFromMessages(e){let t=0,n=0,a=0;this.modelName==="gpt-3.5-turbo-0301"?(n=4,a=-1):(n=3,a=1);const s=await Promise.all(e.map(async i=>{var h,m,f,v,p;const o=await this.getNumTokens(i.content),u=await this.getNumTokens(_o(i)),c=i.name!==void 0?a+await this.getNumTokens(i.name):0;let l=o+n+u+c;const d=i;return d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(m=d==null?void 0:d.additional_kwargs.function_call)!=null&&m.name&&(l+=await this.getNumTokens((f=d.additional_kwargs.function_call)==null?void 0:f.name)),(v=d.additional_kwargs.function_call)!=null&&v.arguments&&(l+=await this.getNumTokens(JSON.stringify(JSON.parse((p=d.additional_kwargs.function_call)==null?void 0:p.arguments)))),t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(a){throw Hh(a)}})}_getClientOptions(e){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},a=zh(n),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new G(s)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}async function Qh(){return(await rr.keys()).filter(e=>e.startsWith("chat-metadata:")).length}async function vo(r){return await rr.getItem(`chat:${r}`)||[]}async function Yh(r,e,t){const n=await vo(r);n.length||await rr.setItem(`chat-metadata:${r}`,{label:"Chat "+(await Qh()+1)}),n.push(["human",e]),await rr.setItem(`chat:${r}`,n);const a=[new Ti("You are a helpful AI assistant.")];for(const[u,c]of n)u==="human"?a.push(new hr(c)):a.push(new ja(c));const i=await new Xh({configuration:{baseURL:await window.electronAPI.ensureLLM()},openAIApiKey:"sk-XxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx"}).stream(a,{signal:t});let o="";return i.pipeThrough(new TransformStream({transform(u,c){let l=typeof u.content=="string"?u.content:"";o+=l,c.enqueue(l)},async flush(){n.push(["assistant",o.trim()]),await rr.setItem(`chat:${r}`,n)}}))}function ef(){return Date.now().toString(36)+Math.random().toString(36).slice(2)}const oa=new WeakMap;function tf(r,e){var s;const t=(s=oa.get(r))==null?void 0:s.get(e);if(t)return t;const n=r.read(),a=oa.get(r)??new Map;return a.set(e,n),oa.set(r,a),n}function wo({reader:r,level:e=0}){H.useEffect(()=>{var a;(a=document.getElementById("messages"))==null||a.scrollTo(0,9999999)},[]);const{done:t,value:n}=H.use(tf(r,e));return t?F.jsx(F.Fragment,{children:n}):F.jsxs(F.Fragment,{children:[n,F.jsx(H.Suspense,{fallback:"...",children:F.jsx(wo,{reader:r,level:e+1})})]})}const Bf=({data:r})=>{var e;return[{title:`Remix LLM | ${((e=r==null?void 0:r.metadata)==null?void 0:e.label)||"New Chat"}`},{name:"description",content:"Create a new chat."}]};async function Zf({params:{chatId:r}}){if(!r)throw $o(`/chat/${ef()}`);const[e,t]=await Promise.all([vo(r),jo(r)]);return{chat:e,metadata:t}}const Ia=xs.object({prompt:xs.string({required_error:"Please enter a message."}).trim().min(1)});async function Vf({request:r,params:{chatId:e}}){if(!e)throw new Error("chatId is required");const t=await r.formData(),n=_i(t,{schema:Ia});if(n.status!=="success")return{lastResult:n.reply()};const a=await Yh(e,n.value.prompt,r.signal);return{userMessage:n.value.prompt,aiResponse:F.jsx(wo,{reader:a.getReader()}),lastResult:n.reply({})}}function zf(){const{chat:r}=To(),{chatId:e}=So(),n=ei().state==="submitting",[a,s]=H.useReducer((d,h)=>[...d,h.newMessage],r),[i,o]=Ec(d=>{Vr.flushSync(()=>{var m;s({action:"sendMessage",newMessage:["human",String(d.get("prompt"))]}),(m=document.getElementById("messages"))==null||m.scrollTo(0,9999999)});const h=document.getElementById(l.prompt.id);h&&(h.value="",h.focus())},d=>{var h;d.aiResponse&&(Vr.flushSync(()=>{s({action:"sendMessage",newMessage:["assistant",d.aiResponse]})}),(h=document.getElementById("messages"))==null||h.scrollTo(0,9999999))}),u=H.useRef(null),[c,l]=mu({lastResult:o==null?void 0:o.lastResult,constraint:_c(Ia),shouldValidate:"onInput",shouldRevalidate:"onInput",onValidate({formData:d}){return _i(d,{schema:Ia})},id:e});return H.useEffect(()=>{var d;(d=document.getElementById("messages"))==null||d.scrollTo(0,9999999)},[a]),F.jsxs("div",{className:"flex-1 flex flex-col overflow-y-hidden",children:[F.jsxs("div",{id:"messages",className:"flex-1 flex flex-col min-h-0 overflow-y-auto container py-4",children:[a.map(([d,h],m)=>F.jsxs("div",{className:"flex flex-col space-y-1",children:[F.jsx("div",{className:"font-medium",children:d}),F.jsx("pre",{className:"text-muted-foreground font-sans text-wrap m-0",children:F.jsx(H.Suspense,{fallback:"...",children:h})})]},""+m+":"+d+h)),n&&F.jsxs("div",{className:"flex flex-col space-y-1",children:[F.jsx("div",{className:"font-medium",children:"assistant"}),F.jsx("pre",{className:"text-muted-foreground font-sans text-wrap m-0",children:"..."})]})]}),F.jsx(xi,{className:"sr-only",htmlFor:l.prompt.id,children:"New Message"}),F.jsxs("form",{...pu(c),...i,ref:u,className:"space-y-4 container py-4 border-t border-border",children:[F.jsx(vi,{...bu(l.prompt),onKeyDown:d=>{var h;d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),(h=u.current)==null||h.requestSubmit())}}),F.jsxs("div",{className:"flex items-center justify-end gap-4",children:[F.jsxs("div",{className:"flex-1 text-sm text-destructive",children:[F.jsx("div",{id:l.prompt.errorId,children:l.prompt.errors}),F.jsx("div",{children:c.errors})]}),F.jsx(No,{disableOnFormSubmission:!0,children:"Send Message"})]})]})]})}export{Vf as clientAction,Zf as clientLoader,zf as default,Bf as meta};
